// ========================================
// OTRUJJAH - Ù†Ø¸Ø§Ù… JavaScript Ù…Ø­Ø³Ù‘Ù† V5.1 FIXED
// ========================================

/* ========== 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª ========== */
const CONFIG = {
    API_URL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:3000/api'
        : '/api',
    ITEMS_PER_PAGE: 12,
    ANIMATION_DURATION: 400,
    TOAST_DURATION: 8000,
    TOAST_SUCCESS_DURATION: 4000,
    TOAST_ERROR_DURATION: 10000,
    TOAST_WARNING_DURATION: 6000,
    CAROUSEL_INTERVAL: 5000,
    DEBOUNCE_DELAY: 300,
    STORAGE_KEY: 'otrujjah_data',
    TOKEN_KEY: 'otrujjah_auth_token',
    USER_DATA_KEY: 'otrujjah_user_data',
    SHIPPING_COST: 50,
    WHATSAPP_NUMBER: '+201100836700',
    MAX_CART_ITEMS: 30,
    PAGE_TRANSITION_DELAY: 3000,
    SUCCESS_MESSAGE_DURATION: 5000
};

/* ========== 2. Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ========== */
const AppState = {
    allProducts: [],
    filteredProducts: [],
    currentPage: 1,
    currentFilter: 'all',
    searchTerm: '',
    currentSort: 'newest',
    cart: [],
    wishlist: [],
    currentUser: null,
    isLoggedIn: false,
    currentCategory: null,
    isLoading: false,
    isMobileMenuOpen: false,
    orders: []
};

/* ========== 2.5. Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠØ¹ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØ± ========== */
function normalizeImagePath(imagePath) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… logo ÙƒÙ€ placeholder
    const PLACEHOLDER = 'assets/images/logo.png';

    if (!imagePath) {
        console.warn('âš ï¸ No image path provided, using placeholder');
        return PLACEHOLDER;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ (http/https)
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
        console.log('âœ… External URL:', imagePath);
        return imagePath;
    }

    // Ø¥Ø²Ø§Ù„Ø© / Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    if (imagePath.startsWith('/')) {
        imagePath = imagePath.substring(1);
    }

    let finalPath;

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¨Ø¯Ø£ Ø¨Ù€ assets/ (Ø¨Ø¯ÙˆÙ† client/)
    if (imagePath.startsWith('assets/')) {
        finalPath = imagePath;
    }
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¨Ø¯Ø£ Ø¨Ù€ client/
    else if (imagePath.startsWith('client/')) {
        // Ø¥Ø²Ø§Ù„Ø© "client/" Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        finalPath = imagePath.substring(7);
    }
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ client/ Ø£Ùˆ assets/
    else {
        finalPath = imagePath;
    }

    console.log('ğŸ”„ Client normalized path:', { original: imagePath, final: finalPath });
    return finalPath;
}

/* ========== 3. Ø®Ø¯Ù…Ø© API ========== */
class ApiService {
    static async request(endpoint, options = {}) {
        const token = this.getToken();
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        try {
            const response = await fetch(`${CONFIG.API_URL}${endpoint}`, {
                ...options,
                headers
            });

            const text = await response.text();
            const data = text ? JSON.parse(text) : null;

            if (!response.ok) {
                throw new Error(data?.error || data?.message || `HTTP Error: ${response.status}`);
            }

            return data && data.success !== undefined ? data : { success: true, data };
        } catch (error) {
            console.error('API Error:', error);
            return { success: false, error: error.message };
        }
    }

    static async get(endpoint) {
        return this.request(endpoint, { method: 'GET' });
    }

    static async post(endpoint, body) {
        return this.request(endpoint, {
            method: 'POST',
            body: JSON.stringify(body)
        });
    }

    static async put(endpoint, body) {
        return this.request(endpoint, {
            method: 'PUT',
            body: JSON.stringify(body)
        });
    }

    static async delete(endpoint) {
        return this.request(endpoint, { method: 'DELETE' });
    }

    static getToken() {
        return localStorage.getItem(CONFIG.TOKEN_KEY) ||
            sessionStorage.getItem(CONFIG.TOKEN_KEY);
    }

    static setToken(token, remember = false) {
        const storage = remember ? localStorage : sessionStorage;
        storage.setItem(CONFIG.TOKEN_KEY, token);
    }

    static removeToken() {
        localStorage.removeItem(CONFIG.TOKEN_KEY);
        sessionStorage.removeItem(CONFIG.TOKEN_KEY);
    }
}

/* ========== 4. Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ========== */
class StorageService {
    static save(key, data) {
        try {
            localStorage.setItem(key, JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('Storage save error:', e);
            return false;
        }
    }

    static load(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        } catch (e) {
            console.error('Storage load error:', e);
            return null;
        }
    }

    static remove(key) {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (e) {
            console.error('Storage remove error:', e);
            return false;
        }
    }

    static clear() {
        try {
            localStorage.clear();
            sessionStorage.clear();
            return true;
        } catch (e) {
            console.error('Storage clear error:', e);
            return false;
        }
    }
}

/* ========== 5. Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ========== */
class AuthService {
    static async login(credentials, remember = false) {
        const endpoint = credentials.email === 'ad9002500@gmail.com'
            ? '/auth/admin/login'
            : '/auth/login';

        const result = await ApiService.post(endpoint, credentials);

        console.log('ğŸ” Login result:', result);

        if (result.success) {
            // Backend returns: { success: true, token: "...", data: { userId, username, email, role } }
            const token = result.token;
            const responseData = result.data || {};
            const { userId, username, email, role } = responseData;

            console.log('ğŸ“¦ Extracted data:', { token, userId, username, email, role });

            if (!token || !userId) {
                console.error('âŒ Login response missing token or userId:', result);
                return { success: false, error: 'Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…' };
            }

            ApiService.setToken(token, remember);

            const userData = { id: parseInt(userId, 10), username, email, role };
            StorageService.save(CONFIG.USER_DATA_KEY, userData);

            AppState.currentUser = userData;
            AppState.isLoggedIn = true;

            console.log('âœ… User logged in:', userData);

            const storage = remember ? localStorage : sessionStorage;
            const roleStr = role ? role.toString().toLowerCase().trim() : '';
            if (roleStr === 'admin' || roleStr === 'administrator') {
                storage.setItem('otrujjah_admin_token', token);
                storage.setItem('otrujjah_admin_user', JSON.stringify(userData));
            } else {
                localStorage.removeItem('otrujjah_admin_token');
                sessionStorage.removeItem('otrujjah_admin_token');
                localStorage.removeItem('otrujjah_admin_user');
                sessionStorage.removeItem('otrujjah_admin_user');
            }

            return { success: true, user: userData };
        }

        console.error('âŒ Login failed:', result);
        return result;
    }

    static async register(userData) {
        return await ApiService.post('/auth/register', userData);
    }

    static logout() {
        ApiService.removeToken();
        StorageService.remove(CONFIG.USER_DATA_KEY);
        localStorage.removeItem('otrujjah_admin_token');
        sessionStorage.removeItem('otrujjah_admin_token');
        localStorage.removeItem('otrujjah_admin_user');
        sessionStorage.removeItem('otrujjah_admin_user');
        AppState.currentUser = null;
        AppState.isLoggedIn = false;
        AppState.orders = [];
    }

    static loadUserFromStorage() {
        const token = ApiService.getToken();
        const userData = StorageService.load(CONFIG.USER_DATA_KEY);

        if (token && userData) {
            userData.id = parseInt(userData.id, 10);
            AppState.currentUser = userData;
            AppState.isLoggedIn = true;
            return true;
        }

        AppState.currentUser = null;
        AppState.isLoggedIn = false;
        return false;
    }

    static isAuthenticated() {
        if (AppState.isLoggedIn && AppState.currentUser) {
            return true;
        }

        const token = ApiService.getToken();
        const userData = StorageService.load(CONFIG.USER_DATA_KEY);

        if (token && userData) {
            userData.id = parseInt(userData.id, 10);
            AppState.currentUser = userData;
            AppState.isLoggedIn = true;
            return true;
        }

        return false;
    }

    static async updateProfile(profileData) {
        if (!this.isAuthenticated()) {
            return { success: false, message: 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹' };
        }

        const result = await ApiService.put(`/users/${AppState.currentUser.id}`, profileData);

        if (result.success) {
            AppState.currentUser = { ...AppState.currentUser, ...profileData };
            StorageService.save(CONFIG.USER_DATA_KEY, AppState.currentUser);
        }

        return result;
    }
}

/* ========== 6. Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ========== */
class ProductService {
    static async loadAll() {
        const result = await ApiService.get('/products');

        if (result.success) {
            AppState.allProducts = result.data.map(p => {
                let categoryKeys = [];
                if (p.categoryKeys && Array.isArray(p.categoryKeys)) {
                    categoryKeys = p.categoryKeys;
                } else if (p.categories) {
                    try {
                        categoryKeys = typeof p.categories === 'string' ? JSON.parse(p.categories) : p.categories;
                    } catch (e) {
                        categoryKeys = [];
                    }
                }

                return {
                    ...p,
                    name: p.name || p.product_name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø³Ù…Ù‰',
                    price: parseFloat(p.price) || 0,
                    image: (p.imageUrl || p.image || 'assets/images/placeholder.png').startsWith('/client/')
                        ? (p.imageUrl || p.image).substring(1)
                        : (p.imageUrl || p.image || 'assets/images/placeholder.png'),
                    topNotes: p.topNotes || p.top_notes || '',
                    middleNotes: p.middleNotes || p.middle_notes || '',
                    baseNotes: p.baseNotes || p.base_notes || '',
                    type: p.type || p.product_type || 'Ù…Ø­Ø§ÙŠØ¯',
                    categoryKeys: categoryKeys
                };
            });

            return { success: true, products: AppState.allProducts };
        }

        return result;
    }

    static async getById(id) {
        const result = await ApiService.get(`/products/${id}`);

        if (result.success) {
            return {
                success: true,
                product: {
                    ...result.data,
                    name: result.data.name || result.data.product_name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø³Ù…Ù‰',
                    price: parseFloat(result.data.price) || 0,
                    image: (result.data.imageUrl || result.data.image || 'assets/images/placeholder.png').startsWith('/client/')
                        ? (result.data.imageUrl || result.data.image).substring(1)
                        : (result.data.imageUrl || result.data.image || 'assets/images/placeholder.png'),
                    topNotes: result.data.topNotes || result.data.top_notes || '',
                    middleNotes: result.data.middleNotes || result.data.middle_notes || '',
                    baseNotes: result.data.baseNotes || result.data.base_notes || '',
                    type: result.data.type || result.data.product_type || 'Ù…Ø­Ø§ÙŠØ¯'
                }
            };
        }

        return result;
    }

    static findById(id) {
        return AppState.allProducts.find(p => p.id === parseInt(id));
    }

    static filter(filters = {}) {
        let products = [...AppState.allProducts];

        if (filters.category) {
            products = products.filter(p => {
                const categoryKeys = p.categoryKeys || [];
                return categoryKeys && categoryKeys.includes(filters.category);
            });
        }

        if (filters.search) {
            const term = filters.search.toLowerCase();
            products = products.filter(p =>
                (p.name && p.name.toLowerCase().includes(term)) ||
                (p.description && p.description.toLowerCase().includes(term)) ||
                (p.topNotes && p.topNotes.toLowerCase().includes(term)) ||
                (p.middleNotes && p.middleNotes.toLowerCase().includes(term)) ||
                (p.baseNotes && p.baseNotes.toLowerCase().includes(term))
            );
        }

        if (filters.note && filters.note !== 'all') {
            const keywords = PERFUME_NOTES[filters.note] || [];
            products = products.filter(p => {
                const allNotes = `${p.topNotes || ''} ${p.middleNotes || ''} ${p.baseNotes || ''}`.toLowerCase();
                return keywords.some(k => allNotes.includes(k.toLowerCase()));
            });
        }

        return this.sort(products, filters.sort || 'newest');
    }

    static sort(products, sortType) {
        const sorted = [...products];

        switch (sortType) {
            case 'price-low':
                return sorted.sort((a, b) => a.price - b.price);
            case 'price-high':
                return sorted.sort((a, b) => b.price - a.price);
            case 'name':
                return sorted.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            case 'newest':
            default:
                return sorted.sort((a, b) => b.id - a.id);
        }
    }
}

/* ========== 7. Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ù„Ø© ========== */
class CartService {
    static addItem(productId) {
        const product = ProductService.findById(productId);
        if (!product) return { success: false, message: 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };

        const existingItem = AppState.cart.find(item => item.id === productId);

        if (existingItem) {
            if (existingItem.quantity >= CONFIG.MAX_CART_ITEMS) {
                return { success: false, message: 'ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ©' };
            }
            existingItem.quantity++;
        } else {
            AppState.cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                image: normalizeImagePath(product.image),
                quantity: 1
            });
        }

        this.save();
        return { success: true, message: 'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­' };
    }

    static removeItem(productId) {
        AppState.cart = AppState.cart.filter(item => item.id !== productId);
        this.save();
        return { success: true, message: 'ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ù„Ø©' };
    }

    static updateQuantity(productId, quantity) {
        const item = AppState.cart.find(i => i.id === productId);

        if (!item) return { success: false, message: 'Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };

        if (quantity <= 0) {
            return this.removeItem(productId);
        }

        if (quantity > CONFIG.MAX_CART_ITEMS) {
            return { success: false, message: 'Ø§Ù„ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­' };
        }

        item.quantity = quantity;
        this.save();
        return { success: true };
    }

    static clear() {
        AppState.cart = [];
        this.save();
        return { success: true, message: 'ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©' };
    }

    static getTotal() {
        return AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    }

    static getCount() {
        return AppState.cart.reduce((sum, item) => sum + item.quantity, 0);
    }

    static save() {
        StorageService.save(CONFIG.STORAGE_KEY, {
            cart: AppState.cart,
            wishlist: AppState.wishlist
        });
    }

    static load() {
        const data = StorageService.load(CONFIG.STORAGE_KEY);
        if (data) {
            AppState.cart = data.cart || [];
            AppState.wishlist = data.wishlist || [];
        }
    }
}

/* ========== 8. Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© ========== */
class WishlistService {
    static toggle(productId) {
        const index = AppState.wishlist.findIndex(id => id === productId);

        if (index > -1) {
            AppState.wishlist.splice(index, 1);
            CartService.save();
            return { success: true, added: false, message: 'ØªÙ… Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' };
        } else {
            AppState.wishlist.push(productId);
            CartService.save();
            return { success: true, added: true, message: 'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©' };
        }
    }

    static isInWishlist(productId) {
        return AppState.wishlist.includes(productId);
    }

    static clear() {
        AppState.wishlist = [];
        CartService.save();
        return { success: true, message: 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…ÙØ¶Ù„Ø©' };
    }

    static getProducts() {
        return AppState.wishlist
            .map(id => ProductService.findById(id))
            .filter(p => p != null);
    }
}

/* ========== 9. Ø®Ø¯Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
class OrderService {

    /**
     * ğŸ”’ [SECURITY FIXED]
     * ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù…Ù†Ø© ÙÙ‚Ø·.
     * Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø±Ø³Ù„ user_id Ø£Ùˆ total_amount Ø£Ùˆ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.
     * Ø§Ù„Ø®Ø§Ø¯Ù… (Backend) Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø¬Ù„Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†ÙØ³Ù‡.
     */
    static async create(orderData) {
        if (AppState.cart.length === 0) {
            return { success: false, error: 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©' };
        }

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø®Ø§Ø¯Ù… Ø³ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ ID Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†)
        if (!AuthService.isAuthenticated()) {
            AuthService.loadUserFromStorage();
            if (!AuthService.isAuthenticated()) {
                UIService.showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html?redirect=checkout.html';
                }, 1500);
                return { success: false, error: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨' };
            }
        }

        // 2. [FIXED] Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø© (ID Ùˆ quantity ÙÙ‚Ø·)
        const productData = AppState.cart.map(item => ({
            id: item.id,
            quantity: item.quantity
        }));

        // 3. [FIXED] Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø³Ø©
        const orderRequest = {
            // "user_id" ØªÙ… Ø­Ø°ÙÙ‡ (Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ£Ø®Ø°Ù‡ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†)
            // "total_amount" ØªÙ… Ø­Ø°ÙÙ‡ (Ø§Ù„Ø®Ø§Ø¯Ù… Ø³ÙŠØ­Ø³Ø¨Ù‡)
            products: productData, // Ø§Ù„Ø¢Ù† ÙŠØ­ØªÙˆÙŠ ÙÙ‚Ø· Ø¹Ù„Ù‰ ID Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ©
            shipping_address: {
                first_name: orderData.firstName,
                last_name: orderData.lastName,
                phone: orderData.phone,
                governorate: orderData.governorate,
                city: orderData.city,
                address: orderData.address,
                notes: orderData.notes
            },
            payment_method: orderData.paymentMethod
        };

        // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        const result = await ApiService.post('/orders', orderRequest);

        if (result.success) {
            CartService.clear();
            await this.loadUserOrders();
        }

        return result;
    }

    static async loadUserOrders() {
        if (!AuthService.isAuthenticated()) {
            return { success: false, message: 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' };
        }

        const result = await ApiService.get(`/orders/user/${AppState.currentUser.id}`);

        if (result.success) {
            AppState.orders = result.data || [];
            return { success: true, orders: AppState.orders };
        }

        return result;
    }

    static generateWhatsAppMessage(orderData) {
        let message = 'ğŸ›ï¸ *Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± Otrujjah*\n\n';

        message += '*Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:*\n';
        AppState.cart.forEach((item, index) => {
            message += `${index + 1}. ${item.name}\n`;
            message += `   Ø§Ù„Ø³Ø¹Ø±: ${item.price} Ø¬.Ù… Ã— ${item.quantity}\n`;
        });

        const subtotal = CartService.getTotal();
        message += `\n*Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:* ${subtotal} Ø¬.Ù…\n`;
        message += `*Ø§Ù„Ø´Ø­Ù†:* ${CONFIG.SHIPPING_COST} Ø¬.Ù…\n`;
        message += `*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:* ${subtotal + CONFIG.SHIPPING_COST} Ø¬.Ù…\n\n`;

        message += '*Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:*\n';
        message += `Ø§Ù„Ø§Ø³Ù…: ${orderData.firstName} ${orderData.lastName}\n`;
        message += `Ø§Ù„Ù‡Ø§ØªÙ: ${orderData.phone}\n`;
        message += `Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${orderData.governorate}\n`;
        message += `Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${orderData.city}\n`;
        message += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${orderData.address}\n`;

        if (orderData.notes) {
            message += `\n*Ù…Ù„Ø§Ø­Ø¸Ø§Øª:* ${orderData.notes}\n`;
        }

        message += `\n*Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:* ${this.getPaymentMethodName(orderData.paymentMethod)}`;

        return message;
    }

    static getPaymentMethodName(method) {
        const methods = {
            'cod': 'Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…',
            'vodafone': 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´',
            'instapay': 'Ø§Ù†Ø³ØªØ§ Ø¨Ø§ÙŠ'
        };
        return methods[method] || method;
    }
}

/* ========== 10. Ø®Ø¯Ù…Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ========== */
class UIService {
    static showToast(message, type = 'info') {
        const toastId = `toast-${Date.now()}`;
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `toast-notification ${type} show`;
        toast.setAttribute('role', 'alert');

        const icons = {
            success: '<i class="fas fa-check-circle"></i>',
            error: '<i class="fas fa-times-circle"></i>',
            warning: '<i class="fas fa-exclamation-triangle"></i>',
            info: '<i class="fas fa-info-circle"></i>'
        };

        toast.innerHTML = `
            <div class="toast-icon">${icons[type] || icons.info}</div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
        `;

        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.style.cssText = 'position: fixed; top: 20px; left: 20px; z-index: 10000;';
            document.body.appendChild(container);
        }

        container.appendChild(toast);

        let duration;
        switch (type) {
            case 'success':
                duration = CONFIG.TOAST_SUCCESS_DURATION;
                break;
            case 'error':
                duration = CONFIG.TOAST_ERROR_DURATION;
                break;
            case 'warning':
                duration = CONFIG.TOAST_WARNING_DURATION;
                break;
            default:
                duration = CONFIG.TOAST_DURATION;
        }

        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    static showLoading(show, message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
        let indicator = document.getElementById('loading-indicator');

        if (show) {
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loading-indicator';
                indicator.className = 'loading-indicator';
                indicator.innerHTML = `<div class="spinner"></div><p>${message}</p>`;
                document.body.appendChild(indicator);
            }
            indicator.querySelector('p').textContent = message;
            indicator.style.display = 'flex';
        } else if (indicator) {
            indicator.style.display = 'none';
        }

        AppState.isLoading = show;
    }

    static updateCartBadge() {
        const badges = document.querySelectorAll('#cart-count, .cart-badge');
        const count = CartService.getCount();
        badges.forEach(badge => {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
        });
    }

    static updateWishlistBadge() {
        const badges = document.querySelectorAll('#wishlist-count, .wishlist-badge');
        const count = AppState.wishlist.length;
        badges.forEach(badge => {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
        });
    }

    static updateAuthUI() {
        const guestMenu = document.getElementById('guest-menu');
        const loggedInMenu = document.getElementById('logged-in-menu');
        const userNameDisplay = document.getElementById('user-name-display');

        if (AppState.isLoggedIn && AppState.currentUser) {
            if (guestMenu) guestMenu.style.display = 'none';
            if (loggedInMenu) loggedInMenu.style.display = 'block';
            if (userNameDisplay) userNameDisplay.textContent = AppState.currentUser.username;
        } else {
            if (guestMenu) guestMenu.style.display = 'block';
            if (loggedInMenu) loggedInMenu.style.display = 'none';
            if (userNameDisplay) userNameDisplay.textContent = 'Ø­Ø³Ø§Ø¨ÙŠ';
        }
    }

    static closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
    }

    static scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

/* ========== 11. Ù…Ø¯ÙŠØ± Ø§Ù„ØµÙØ­Ø§Øª ========== */
class PageManager {
    constructor() {
        this.currentPage = this.detectPage();
    }

    detectPage() {
        const path = window.location.pathname;
        const pageName = path.split('/').pop() || 'index.html';

        if (pageName.includes('product.html')) return 'product';
        if (pageName.includes('login.html')) return 'login';
        if (pageName.includes('register.html')) return 'register';
        if (pageName.includes('car.html')) return 'cart';
        if (pageName.includes('favoret.html')) return 'wishlist';
        if (pageName.includes('checkout.html')) return 'checkout';

        const pageType = document.body.dataset.pageType;
        if (pageType === 'category') return 'category';

        return 'home';
    }

    async initialize() {
        switch (this.currentPage) {
            case 'home':
                await this.initHomePage();
                break;
            case 'category':
                await this.initCategoryPage();
                break;
            case 'product':
                await this.initProductPage();
                break;
            case 'login':
                this.initLoginPage();
                break;
            case 'register':
                this.initRegisterPage();
                break;
            case 'cart':
                this.initCartPage();
                break;
            case 'wishlist':
                this.initWishlistPage();
                break;
            case 'checkout':
                this.initCheckoutPage();
                break;
        }
    }

    async initHomePage() {
        this.setupProductDisplay();
        this.setupFilters();
        this.setupSearch();
        this.setupHeroCarousel();
    }

    async initCategoryPage() {
        AppState.currentCategory = document.body.dataset.category;
        this.setupProductDisplay();
        this.setupFilters();
        this.setupSearch();
    }

    async initProductPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = parseInt(urlParams.get('id'));

        if (!productId) {
            window.location.href = 'index.html';
            return;
        }

        await this.loadProductDetails(productId);
    }

    initLoginPage() {
        const form = document.getElementById('login-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleLogin(e);
            });
        }
    }

    initRegisterPage() {
        const form = document.getElementById('register-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleRegister(e);
            });
        }
        this.setupPasswordValidation();
    }

    initCartPage() {
        this.renderCartPage();
    }

    initWishlistPage() {
        this.renderWishlistPage();
    }

    initCheckoutPage() {
        AuthService.loadUserFromStorage();

        if (!AuthService.isAuthenticated() || !AppState.currentUser) {
            UIService.showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨', 'warning');
            setTimeout(() => {
                window.location.href = 'login.html?redirect=checkout.html';
            }, 1500);
            return;
        }

        if (AppState.cart.length === 0) {
            UIService.showToast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©. Ø§Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'warning');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
            return;
        }

        this.renderCheckoutSummary();
        this.prefillUserInfo();
        const form = document.getElementById('checkout-form');
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleCheckout(e);
            });
        }
    }

    setupHeroCarousel() {
        const bottleItems = document.querySelectorAll('.bottle-item');
        const dots = document.querySelectorAll('.bottle-dots .dot');
        let currentIndex = 0;

        if (bottleItems.length === 0 || dots.length === 0) return;

        this.loadHeroImages();

        const showSlide = (index) => {
            bottleItems.forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        };

        const nextSlide = () => {
            currentIndex = (currentIndex + 1) % bottleItems.length;
            showSlide(currentIndex);
        };

        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => {
                currentIndex = index;
                showSlide(currentIndex);
            });
        });

        setInterval(nextSlide, CONFIG.CAROUSEL_INTERVAL);
    }

    loadHeroImages() {
        const productsWithImages = AppState.allProducts.filter(p => p.image && p.image.trim() !== '');

        if (productsWithImages.length >= 3) {
            const shuffled = productsWithImages.sort(() => 0.5 - Math.random());
            const randomProducts = shuffled.slice(0, 3);

            const bottleItems = document.querySelectorAll('.bottle-item img');
            bottleItems.forEach((img, index) => {
                if (randomProducts[index]) {
                    img.src = randomProducts[index].image;
                    img.alt = randomProducts[index].name;
                }
            });
        }
    }

    setupProductDisplay() {
        this.applyFilters();
        this.setupSort();
        this.setupViewToggle();
    }

    setupFilters() {
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                AppState.currentFilter = btn.dataset.filter;
                this.applyFilters();
            });
        });
    }

    setupSearch() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', this.debounce((e) => {
                AppState.searchTerm = e.target.value;
                this.applyFilters();
            }, CONFIG.DEBOUNCE_DELAY));
        }
    }

    setupSort() {
        const sortSelect = document.getElementById('sort-select');
        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                AppState.currentSort = e.target.value;
                this.applyFilters();
            });
        }
    }

    setupViewToggle() {
        const gridBtn = document.getElementById('grid-view-btn');
        const listBtn = document.getElementById('list-view-btn');
        const productList = document.getElementById('product-list');

        gridBtn?.addEventListener('click', () => {
            gridBtn.classList.add('active');
            listBtn?.classList.remove('active');
            productList?.classList.remove('list-view');
        });

        listBtn?.addEventListener('click', () => {
            listBtn.classList.add('active');
            gridBtn?.classList.remove('active');
            productList?.classList.add('list-view');
        });
    }

    setupPasswordValidation() {
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirm-password');

        password?.addEventListener('input', (e) => {
            this.updatePasswordStrength(e.target.value);
        });

        confirmPassword?.addEventListener('input', () => {
            this.validatePasswordMatch();
        });
    }

    updatePasswordStrength(password) {
        const strengthBar = document.getElementById('strength-bar-fill');
        const strengthText = document.getElementById('strength-text');

        if (!strengthBar || !strengthText) return;

        let strength = 0;
        if (password.length >= 6) strength++;
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[!@#$%^&*]/.test(password)) strength++;

        const percentage = (strength / 5) * 100;
        strengthBar.style.width = `${percentage}%`;

        const levels = ['Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹', 'Ø¶Ø¹ÙŠÙØ©', 'Ù…ØªÙˆØ³Ø·Ø©', 'Ù‚ÙˆÙŠØ©', 'Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹'];
        const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997'];

        strengthText.textContent = levels[strength - 1] || 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±';
        strengthBar.style.backgroundColor = colors[strength - 1] || '#e9ecef';
    }

    validatePasswordMatch() {
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirm-password');
        const hint = document.getElementById('password-match-hint');

        if (!password || !confirmPassword || !hint) return;

        if (confirmPassword.value) {
            if (password.value === confirmPassword.value) {
                hint.textContent = 'âœ“ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
                hint.style.color = '#28a745';
            } else {
                hint.textContent = 'âœ— ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
                hint.style.color = '#dc3545';
            }
        } else {
            hint.textContent = '';
        }
    }

    applyFilters() {
        UIService.showLoading(true);

        const filters = {
            category: AppState.currentCategory,
            search: AppState.searchTerm,
            note: AppState.currentFilter,
            sort: AppState.currentSort
        };

        AppState.filteredProducts = ProductService.filter(filters);
        this.renderProducts(AppState.filteredProducts);

        UIService.showLoading(false);
    }

    renderProducts(products) {
        const productList = document.getElementById('product-list');
        const noProductsMsg = document.getElementById('no-products-message');

        if (!productList) return;

        productList.innerHTML = '';

        if (products.length === 0) {
            if (noProductsMsg) noProductsMsg.style.display = 'block';
        } else {
            if (noProductsMsg) noProductsMsg.style.display = 'none';
            products.forEach(product => {
                productList.insertAdjacentHTML('beforeend', this.createProductCard(product));
            });
        }
    }

    createProductCard(product) {
        const isWished = WishlistService.isInWishlist(product.id);
        const imagePath = normalizeImagePath(product.image);

        return `
            <div class="product-card fade-in" data-product-id="${product.id}">
                <a href="product.html?id=${product.id}" class="product-link">
                    <div class="product-image-wrapper">
                        <img src="${imagePath}"
                             alt="${product.name}"
                             loading="lazy"
                             onerror="console.error('âŒ Failed to load image:', this.src); if(this.src !== 'assets/images/logo.png') { this.src='assets/images/logo.png'; this.style.objectFit='contain'; }"
                             onload="console.log('âœ… Image loaded:', this.src);">
                        ${product.type ? `<span class="product-badge">${product.type}</span>` : ''}
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-notes">
                            <strong>Ø§Ù„Ù†ÙˆØªØ§Øª:</strong> ${this.truncate(product.topNotes || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 40)}
                        </p>
                        <div class="product-price">${product.price} Ø¬.Ù…</div>
                    </div>
                </a>
                <div class="product-footer">
                    <button class="add-cart-btn" onclick="app.addToCart(${product.id})">
                        <i class="fas fa-shopping-cart"></i> Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©
                    </button>
                    <button class="wishlist-btn ${isWished ? 'active' : ''}"
                            onclick="app.toggleWishlist(${product.id})"
                            title="${isWished ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' : 'Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø©'}">
                        <i class="${isWished ? 'fas' : 'far'} fa-heart"></i>
                    </button>
                </div>
            </div>
        `;
    }

    async loadProductDetails(productId) {
        const container = document.getElementById('product-details-container');
        if (!container) return;

        UIService.showLoading(true, 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„...');

        let product = ProductService.findById(productId);

        if (!product) {
            const result = await ProductService.getById(productId);
            if (result.success) {
                product = result.product;
            } else {
                UIService.showLoading(false);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3>
                        <p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬</p>
                        <a href="index.html" class="btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                    </div>
                `;
                return;
            }
        }

        document.title = `${product.name} - otrujjah`;
        const breadcrumb = document.getElementById('breadcrumb-product-name');
        if (breadcrumb) breadcrumb.textContent = product.name;

        container.innerHTML = this.createProductDetailsHTML(product);
        await this.loadRelatedProducts(product);

        UIService.showLoading(false);
    }

    createProductDetailsHTML(product) {
        const isWished = WishlistService.isInWishlist(product.id);
        const imagePath = normalizeImagePath(product.image);

        return `
            <div class="product-detail-wrapper fade-in">
                <div class="product-image-large">
                    <img src="${imagePath}"
                         alt="${product.name}"
                         onerror="console.error('âŒ Failed to load image:', this.src); if(this.src !== 'assets/images/logo.png') { this.src='assets/images/logo.png'; this.style.objectFit='contain'; }"
                         onload="console.log('âœ… Product detail image loaded:', this.src);">
                    <button class="wishlist-btn-large ${isWished ? 'active' : ''}"
                            onclick="app.toggleWishlist(${product.id})"
                            title="${isWished ? 'Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©' : 'Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø©'}">
                        <i class="${isWished ? 'fas' : 'far'} fa-heart"></i>
                    </button>
                </div>
                <div class="product-info-detail">
                    <h1 class="product-detail-name">${product.name}</h1>
                    <div class="product-detail-price">${product.price} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</div>
                    <p class="product-description">${product.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.'}</p>

                    ${(product.topNotes || product.middleNotes || product.baseNotes) ? `
                    <div class="perfume-pyramid">
                        <h3 class="pyramid-title"><i class="fas fa-layer-group"></i> Ø§Ù„Ù‡Ø±Ù… Ø§Ù„Ø¹Ø·Ø±ÙŠ</h3>
                        ${product.topNotes ? `<div class="pyramid-level"><div class="pyramid-label">Ù‚Ù…Ø© Ø§Ù„Ø¹Ø·Ø±</div><div class="pyramid-notes">${product.topNotes}</div></div>` : ''}
                        ${product.middleNotes ? `<div class="pyramid-level"><div class="pyramid-label">Ù‚Ù„Ø¨ Ø§Ù„Ø¹Ø·Ø±</div><div class="pyramid-notes">${product.middleNotes}</div></div>` : ''}
                        ${product.baseNotes ? `<div class="pyramid-level"><div class="pyramid-label">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ø·Ø±</div><div class="pyramid-notes">${product.baseNotes}</div></div>` : ''}
                    </div>` : ''}

                    <div class="action-buttons">
                        <button class="btn-primary btn-large" onclick="app.addToCart(${product.id})">
                            <i class="fas fa-shopping-cart"></i> Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    async loadRelatedProducts(product) {
        const container = document.getElementById('related-products');
        if (!container) return;

        const related = AppState.allProducts
            .filter(p => p.id !== product.id && p.categoryKeys &&
                product.categoryKeys &&
                p.categoryKeys.some(cat => product.categoryKeys.includes(cat)))
            .slice(0, 4);

        if (related.length > 0) {
            container.innerHTML = related.map(p => this.createProductCard(p)).join('');
        }
    }

    renderCartPage() {
        const cartItems = document.getElementById('cart-items');
        const emptyCart = document.getElementById('empty-cart');
        const itemsCount = document.getElementById('items-count');

        if (!cartItems) return;

        if (AppState.cart.length === 0) {
            if (cartItems) cartItems.style.display = 'none';
            if (emptyCart) emptyCart.style.display = 'flex';
            if (itemsCount) itemsCount.textContent = '0';
        } else {
            if (cartItems) cartItems.style.display = 'block';
            if (emptyCart) emptyCart.style.display = 'none';
            if (itemsCount) itemsCount.textContent = AppState.cart.length;

            cartItems.innerHTML = AppState.cart.map(item => `
                <div class="cart-item" data-product-id="${item.id}">
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-info">
                        <h3 class="cart-item-name">${item.name}</h3>
                        <p class="cart-item-price">${item.price} Ø¬.Ù…</p>
                    </div>
                    <div class="cart-item-quantity">
                        <button onclick="app.updateCartQuantity(${item.id}, ${item.quantity - 1})" class="qty-btn">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" value="${item.quantity}" min="1" max="${CONFIG.MAX_CART_ITEMS}"
                               onchange="app.updateCartQuantity(${item.id}, parseInt(this.value))" class="qty-input">
                        <button onclick="app.updateCartQuantity(${item.id}, ${item.quantity + 1})" class="qty-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="cart-item-total">${item.price * item.quantity} Ø¬.Ù…</div>
                    <button onclick="app.removeFromCart(${item.id})" class="cart-item-remove">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');

            this.updateCartSummary();
        }
    }

    updateCartSummary() {
        const subtotal = CartService.getTotal();
        const total = subtotal + CONFIG.SHIPPING_COST;

        const subtotalEl = document.getElementById('subtotal');
        const shippingEl = document.getElementById('shipping');
        const totalEl = document.getElementById('total');

        if (subtotalEl) subtotalEl.textContent = `${subtotal} Ø¬Ù†ÙŠÙ‡`;
        if (shippingEl) shippingEl.textContent = `${CONFIG.SHIPPING_COST} Ø¬Ù†ÙŠÙ‡`;
        if (totalEl) totalEl.textContent = `${total} Ø¬Ù†ÙŠÙ‡`;
    }

    renderWishlistPage() {
        const wishlistItems = document.getElementById('wishlist-items');
        const emptyWishlist = document.getElementById('empty-wishlist');
        const itemsCount = document.getElementById('wishlist-items-count');

        if (!wishlistItems) return;

        const products = WishlistService.getProducts();

        if (products.length === 0) {
            if (wishlistItems) wishlistItems.style.display = 'none';
            if (emptyWishlist) emptyWishlist.style.display = 'flex';
            if (itemsCount) itemsCount.textContent = '0';
        } else {
            if (wishlistItems) wishlistItems.style.display = 'grid';
            if (emptyWishlist) emptyWishlist.style.display = 'none';
            if (itemsCount) itemsCount.textContent = products.length;

            wishlistItems.innerHTML = products.map(p => this.createProductCard(p)).join('');
        }
    }

    renderCheckoutSummary() {
        const orderItems = document.getElementById('order-items');
        const subtotalEl = document.getElementById('checkout-subtotal');
        const shippingEl = document.getElementById('checkout-shipping');
        const totalEl = document.getElementById('checkout-total');

        if (!orderItems) return;

        if (AppState.cart.length === 0) {
            window.location.href = 'car.html';
            return;
        }

        orderItems.innerHTML = AppState.cart.map(item => `
            <div class="order-item">
                <img src="${item.image}" alt="${item.name}">
                <div class="order-item-info">
                    <h4>${item.name}</h4>
                    <p>${item.quantity} Ã— ${item.price} Ø¬.Ù…</p>
                </div>
                <div class="order-item-total">${item.price * item.quantity} Ø¬.Ù…</div>
            </div>
        `).join('');

        const subtotal = CartService.getTotal();
        const total = subtotal + CONFIG.SHIPPING_COST;

        if (subtotalEl) subtotalEl.textContent = `${subtotal} Ø¬Ù†ÙŠÙ‡`;
        if (shippingEl) shippingEl.textContent = `${CONFIG.SHIPPING_COST} Ø¬Ù†ÙŠÙ‡`;
        if (totalEl) totalEl.textContent = `${total} Ø¬Ù†ÙŠÙ‡`;
    }

    prefillUserInfo() {
        if (!AppState.currentUser) return;

        if (AppState.currentUser.username) {
            const nameParts = AppState.currentUser.username.trim().split(' ');
            const firstNameField = document.getElementById('first-name');
            const lastNameField = document.getElementById('last-name');

            if (firstNameField && nameParts.length > 0) {
                firstNameField.value = nameParts[0];
            }
            if (lastNameField && nameParts.length > 1) {
                lastNameField.value = nameParts.slice(1).join(' ');
            }
        }

        if (AppState.currentUser.phone) {
            const phoneField = document.getElementById('phone');
            if (phoneField) {
                phoneField.value = AppState.currentUser.phone;
            }
        }

        if (AppState.currentUser.email) {
            const emailField = document.getElementById('email');
            if (emailField) {
                emailField.value = AppState.currentUser.email;
            }
        }
    }

    async handleLogin(e) {
        UIService.showLoading(true, 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');

        const email = document.getElementById('email')?.value;
        const password = document.getElementById('password')?.value;
        const remember = document.getElementById('remember')?.checked;
        const errorMsgEl = document.getElementById('error-message');

        if (errorMsgEl) errorMsgEl.textContent = '';

        if (!email || !password) {
            if (errorMsgEl) errorMsgEl.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
            UIService.showLoading(false);
            return;
        }

        const result = await AuthService.login({ email, password }, remember);

        UIService.showLoading(false);

        if (result.success) {
            UIService.showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...', 'success');
            UIService.updateAuthUI();

            const role = result.user.role;
            const isAdmin = role &&
                (role.toString().toLowerCase().trim() === 'admin' ||
                    role.toString().toLowerCase().trim() === 'administrator');

            const urlParams = new URLSearchParams(window.location.search);
            const redirect = urlParams.get('redirect');

            if (isAdmin) {
                setTimeout(() => {
                    window.location.href = '/admin/index.html';
                }, CONFIG.PAGE_TRANSITION_DELAY);
            } else if (redirect) {
                setTimeout(() => {
                    window.location.href = redirect;
                }, CONFIG.PAGE_TRANSITION_DELAY);
            } else {
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, CONFIG.PAGE_TRANSITION_DELAY);
            }
        } else {
            if (errorMsgEl) errorMsgEl.textContent = result.error || 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
            UIService.showToast(result.error || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
        }
    }

    async handleRegister(e) {
        const username = document.getElementById('username')?.value;
        const email = document.getElementById('email')?.value;
        const phone = document.getElementById('phone')?.value;
        const password = document.getElementById('password')?.value;
        const confirmPassword = document.getElementById('confirm-password')?.value;
        const terms = document.getElementById('terms')?.checked;
        const errorMsgEl = document.getElementById('error-message');
        const successMsgEl = document.getElementById('success-message');

        if (errorMsgEl) errorMsgEl.textContent = '';
        if (successMsgEl) successMsgEl.textContent = '';

        if (!username || !email || !phone || !password) {
            if (errorMsgEl) errorMsgEl.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
            return;
        }

        if (password.length < 6) {
            if (errorMsgEl) errorMsgEl.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„';
            return;
        }

        if (password !== confirmPassword) {
            if (errorMsgEl) errorMsgEl.textContent = 'ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
            return;
        }

        const phonePattern = /^01[0-9]{9}$/;
        if (!phonePattern.test(phone)) {
            if (errorMsgEl) errorMsgEl.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…ØµØ±ÙŠ ØµØ­ÙŠØ­';
            return;
        }

        if (!terms) {
            if (errorMsgEl) errorMsgEl.textContent = 'ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…';
            return;
        }

        UIService.showLoading(true, 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...');

        const result = await AuthService.register({
            username,
            email,
            password,
            phone
        });

        UIService.showLoading(false);

        if (result.success) {
            if (successMsgEl) successMsgEl.textContent = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
            UIService.showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...', 'success');

            setTimeout(() => {
                window.location.href = 'login.html';
            }, CONFIG.SUCCESS_MESSAGE_DURATION);
        } else {
            if (errorMsgEl) errorMsgEl.textContent = result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
            UIService.showToast(result.error || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨', 'error');
        }
    }

    async handleCheckout(e) {
        if (!AuthService.isAuthenticated() || !AppState.currentUser || !AppState.currentUser.id) {
            UIService.showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨', 'warning');
            setTimeout(() => {
                window.location.href = 'login.html?redirect=checkout.html';
            }, CONFIG.PAGE_TRANSITION_DELAY);
            return;
        }

        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value;
        const termsChecked = document.getElementById('terms')?.checked;
        const form = e.target;

        if (!termsChecked) {
            UIService.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ø£ÙˆÙ„Ø§Ù‹', 'error');
            return;
        }

        if (!paymentMethod) {
            UIService.showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', 'error');
            return;
        }

        const requiredFields = ['first-name', 'last-name', 'phone', 'governorate', 'city', 'address'];
        let isValid = true;

        form.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value.trim()) {
                isValid = false;
                if (field) {
                    field.classList.add('input-error');
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    break;
                }
            }
        }

        if (!isValid) {
            UIService.showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (*)', 'error');
            return;
        }

        const orderData = {
            paymentMethod,
            firstName: document.getElementById('first-name').value,
            lastName: document.getElementById('last-name').value,
            phone: document.getElementById('phone').value,
            governorate: document.getElementById('governorate').value,
            city: document.getElementById('city').value,
            address: document.getElementById('address').value,
            notes: document.getElementById('notes')?.value || null
        };

        if (paymentMethod === 'vodafone' || paymentMethod === 'instapay') {
            UIService.showLoading(true, 'Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨...');
            const result = await OrderService.create(orderData);
            UIService.showLoading(false);

            if (result.success) {
                const message = OrderService.generateWhatsAppMessage(orderData);
                const whatsappLink = `https://wa.me/${CONFIG.WHATSAPP_NUMBER.replace('+', '')}?text=${encodeURIComponent(message)}`;

                UIService.showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨...', 'success');
                UIService.updateCartBadge();

                setTimeout(() => {
                    window.open(whatsappLink, '_blank');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }, CONFIG.PAGE_TRANSITION_DELAY);
            } else {
                UIService.showToast(`Ø­Ø¯Ø« Ø®Ø·Ø£: ${result.error}`, 'error');
            }
        } else if (paymentMethod === 'cod') {
            UIService.showLoading(true, 'Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ...');

            const result = await OrderService.create(orderData);

            UIService.showLoading(false);

            if (result.success) {
                UIService.updateCartBadge();
                UIService.showToast('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, CONFIG.SUCCESS_MESSAGE_DURATION);
            } else {
                UIService.showToast(`Ø­Ø¯Ø« Ø®Ø·Ø£: ${result.error}`, 'error');
            }
        }
    }

    truncate(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    debounce(func, delay) {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }
}

/* ========== 12. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ========== */
class OtrujjahApp {
    constructor() {
        this.pageManager = new PageManager();
        this.init();
    }

    async init() {
        UIService.showLoading(true, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...');

        CartService.load();
        AuthService.loadUserFromStorage();

        await ProductService.loadAll();
        await this.pageManager.initialize();

        this.setupGlobalComponents();

        setTimeout(() => {
            UIService.updateAuthUI();
            UIService.updateCartBadge();
            UIService.updateWishlistBadge();
        }, 100);

        UIService.showLoading(false);
    }

    setupGlobalComponents() {
        this.setupMobileMenu();
        this.setupAccountDropdown();
        this.setupBackToTop();
        this.setupModalClosers();
        UIService.updateCartBadge();
        UIService.updateWishlistBadge();
        UIService.updateAuthUI();
    }

    setupMobileMenu() {
        const toggle = document.getElementById('mobile-menu-toggle');
        const menu = document.getElementById('mobile-menu');

        toggle?.addEventListener('click', () => {
            AppState.isMobileMenuOpen = !AppState.isMobileMenuOpen;
            toggle.classList.toggle('active');
            menu?.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (AppState.isMobileMenuOpen &&
                !toggle?.contains(e.target) &&
                !menu?.contains(e.target)) {
                AppState.isMobileMenuOpen = false;
                toggle?.classList.remove('active');
                menu?.classList.remove('active');
            }
        });
    }

    setupAccountDropdown() {
        const accountToggle = document.getElementById('account-toggle');
        const accountMenu = document.getElementById('account-menu');

        if (!accountToggle || !accountMenu) return;

        accountMenu.style.display = 'none';

        accountToggle.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const isOpen = accountMenu.style.display === 'block';

            if (isOpen) {
                accountMenu.style.display = 'none';
                accountToggle.classList.remove('active');
            } else {
                accountMenu.style.display = 'block';
                accountToggle.classList.add('active');
            }
        });

        document.addEventListener('click', function (e) {
            if (!accountToggle.contains(e.target) && !accountMenu.contains(e.target)) {
                if (accountMenu.style.display === 'block') {
                    accountMenu.style.display = 'none';
                    accountToggle.classList.remove('active');
                }
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && accountMenu.style.display === 'block') {
                accountMenu.style.display = 'none';
                accountToggle.classList.remove('active');
            }
        });
    }

    setupBackToTop() {
        const backToTopBtn = document.getElementById('back-to-top');

        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                backToTopBtn?.classList.add('visible');
            } else {
                backToTopBtn?.classList.remove('visible');
            }
        });

        backToTopBtn?.addEventListener('click', () => {
            UIService.scrollToTop();
        });
    }

    setupModalClosers() {
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                document.body.style.overflow = '';
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal[style*="display: flex"]');
                openModals.forEach(modal => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                });
            }
        });
    }

    addToCart(productId) {
        const result = CartService.addItem(productId);
        if (result.success) {
            UIService.showToast(result.message, 'success');
            UIService.updateCartBadge();
        } else {
            UIService.showToast(result.message, 'error');
        }
    }

    removeFromCart(productId) {
        const result = CartService.removeItem(productId);
        if (result.success) {
            UIService.showToast(result.message, 'success');
            UIService.updateCartBadge();
            this.pageManager.renderCartPage();
        }
    }

    updateCartQuantity(productId, quantity) {
        const result = CartService.updateQuantity(productId, quantity);
        if (result.success) {
            UIService.updateCartBadge();
            this.pageManager.renderCartPage();
        } else if (result.message) {
            UIService.showToast(result.message, 'error');
        }
    }

    clearCart() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ')) {
            const result = CartService.clear();
            if (result.success) {
                UIService.showToast(result.message, 'success');
                UIService.updateCartBadge();
                this.pageManager.renderCartPage();
            }
        }
    }

    toggleWishlist(productId) {
        const result = WishlistService.toggle(productId);
        if (result.success) {
            UIService.showToast(result.message, result.added ? 'success' : 'info');
            UIService.updateWishlistBadge();

            document.querySelectorAll(`[data-product-id="${productId}"] .wishlist-btn, .wishlist-btn-large`).forEach(btn => {
                btn.classList.toggle('active', result.added);
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = result.added ? 'fas fa-heart' : 'far fa-heart';
                }
            });
        }
    }

    clearWishlist() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ')) {
            const result = WishlistService.clear();
            if (result.success) {
                UIService.showToast(result.message, 'success');
                UIService.updateWishlistBadge();
                this.pageManager.renderWishlistPage();
            }
        }
    }

    logout() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
            AuthService.logout();
            UIService.showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„...', 'success');
            UIService.updateAuthUI();
            setTimeout(() => {
                window.location.href = 'index.html';
            }, CONFIG.PAGE_TRANSITION_DELAY);
        }
    }
}

/* ========== 13. Ø®Ø±ÙŠØ·Ø© Ù†ÙˆØªØ§Øª Ø§Ù„Ø¹Ø·ÙˆØ± ========== */
const PERFUME_NOTES = {
    rose: ['ÙˆØ±Ø¯', 'rose', 'ÙˆØ±Ø¯Ø©'],
    citrus: ['Ø­Ù…Ø¶ÙŠØ§Øª', 'citrus', 'lemon', 'orange', 'Ø¨Ø±ØªÙ‚Ø§Ù„', 'Ù„ÙŠÙ…ÙˆÙ†', 'Ø¨Ø±ØºÙ…ÙˆØª'],
    vanilla: ['ÙØ§Ù†ÙŠÙ„ÙŠØ§', 'vanilla', 'ØªÙˆÙ†ÙƒØ§'],
    musk: ['Ù…Ø³Ùƒ', 'musk', 'Ø¹Ù†Ø¨Ø±'],
    woody: ['Ø®Ø´Ø¨ÙŠ', 'woody', 'oud', 'Ø¹ÙˆØ¯', 'ØµÙ†Ø¯Ù„', 'Ø£Ø±Ø²', 'Ø¨Ø§ØªØ´ÙˆÙ„ÙŠ'],
    floral: ['Ø²Ù‡Ø±ÙŠ', 'floral', 'jasmine', 'ÙŠØ§Ø³Ù…ÙŠÙ†', 'Ø²Ù†Ø¨Ù‚', 'Ù†ÙŠØ±ÙˆÙ„ÙŠ'],
    fruity: ['ÙØ§ÙƒÙ‡ÙŠ', 'fruity', 'apple', 'ØªÙØ§Ø­', 'ÙƒÙ…Ø«Ø±Ù‰', 'ÙØ±Ø§ÙˆÙ„Ø©'],
    spicy: ['ØªÙˆØ§Ø¨Ù„', 'spicy', 'ÙÙ„ÙÙ„', 'Ù‚Ø±ÙØ©']
};

/* ========== 14. Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù…Ø© ========== */
window.app = null;

document.addEventListener('DOMContentLoaded', () => {
    window.app = new OtrujjahApp();
});

// Global functions
function showProfileModal(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    window.location.href = 'profile.html';
}

function showOrdersModal(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    window.location.href = 'orders.html';
}

async function loadUserOrders() {
    const container = document.getElementById('orders-list');
    if (!container) return;

    if (!AppState.currentUser || !AppState.currentUser.id) {
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle fa-3x"></i>
                <p>Ø®Ø·Ø£: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>
            </div>
        `;
        return;
    }

    try {
        const result = await ApiService.get(`/orders/user/${AppState.currentUser.id}`);

        if (result.success && result.data && result.data.length > 0) {
            container.innerHTML = result.data.map(order => {
                let products = [];
                try {
                    products = typeof order.products === 'string' ? JSON.parse(order.products) : order.products;
                } catch (e) {
                    products = [];
                }

                const productsText = products.length > 0 ? products.map(p => p.name || 'Ù…Ù†ØªØ¬').join('ØŒ ') : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª';

                const statusMap = {
                    'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                    'confirmed': 'Ù…Ø¤ÙƒØ¯',
                    'shipped': 'ØªÙ… Ø§Ù„Ø´Ø­Ù†',
                    'delivered': 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„',
                    'cancelled': 'Ù…Ù„ØºÙŠ'
                };

                const statusColorMap = {
                    'pending': '#ffc107',
                    'confirmed': '#17a2b8',
                    'shipped': '#007bff',
                    'delivered': '#28a745',
                    'cancelled': '#dc3545'
                };

                const status = order.status || 'pending';
                const statusText = statusMap[status] || 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
                const statusColor = statusColorMap[status] || '#ffc107';

                return `
                <div class="order-card">
                    <div class="order-header">
                        <span class="order-id"><i class="fas fa-receipt"></i> Ø·Ù„Ø¨ #${order.id}</span>
                        <span class="order-status" style="background: ${statusColor};">${statusText}</span>
                    </div>
                    <div class="order-details">
                        <p><i class="fas fa-calendar"></i> <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(order.created_at).toLocaleDateString('ar-EG')}</p>
                        <p><i class="fas fa-money-bill-wave"></i> <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${order.total_amount} Ø¬.Ù…</p>
                        <p><i class="fas fa-shopping-bag"></i> <strong>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</strong> ${productsText}</p>
                    </div>
                </div>
            `;
            }).join('');
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-box-open fa-4x"></i>
                    <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</h4>
                    <p>Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù† ÙˆØ§Ø·Ù„Ø¨ Ø¹Ø·Ø±Ùƒ Ø§Ù„Ù…ÙØ¶Ù„!</p>
                    <a href="index.html" class="btn-primary">
                        <i class="fas fa-shopping-cart"></i> ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                    </a>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle fa-4x"></i>
                <h4>Ø­Ø¯Ø« Ø®Ø·Ø£</h4>
                <p>Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
                <button onclick="loadUserOrders()" class="btn-primary">
                    <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
            </div>
        `;
    }
}

function showCartModal(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    if (!AuthService.isAuthenticated()) {
        UIService.showToast('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©', 'warning');
        setTimeout(() => {
            window.location.href = 'login.html?redirect=car.html';
        }, 1500);
        return;
    }

    CartService.load();
    window.location.href = 'car.html';
}

function showWishlistModal(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    if (!AuthService.isAuthenticated()) {
        UIService.showToast('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'warning');
        setTimeout(() => {
            window.location.href = 'login.html?redirect=favoret.html';
        }, 1500);
        return;
    }

    window.location.href = 'favoret.html';
}

function filterByCategory(category) {
    const categoryMap = {
        'gift': 'gifts.html',
        'wedding': 'aris.html',
        'bride': 'arosa.html',
        'summer': 'summer.html',
        'winter': 'winter.html',
        'women': 'women.html',
        'women-luxury': 'women.html',
        'men': 'mens.html',
        'men-luxury': 'mens.html',
        'occasions': 'monaspa.html'
    };

    const targetPage = categoryMap[category];
    if (targetPage) {
        window.location.href = targetPage;
    } else {
        window.location.href = 'index.html';
    }
}

function resetFilters() {
    AppState.currentFilter = 'all';
    AppState.searchTerm = '';
    AppState.currentSort = 'newest';

    const searchInput = document.getElementById('search-input');
    if (searchInput) searchInput.value = '';

    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) sortSelect.value = 'newest';

    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === 'all') {
            btn.classList.add('active');
        }
    });

    if (window.app && window.app.pageManager) {
        window.app.pageManager.applyFilters();
    }
}

function logout() {
    if (window.app) {
        window.app.logout();
    }
}

function scrollToTop() {
    UIService.scrollToTop();
}

function scrollToProducts() {
    const element = document.getElementById('products');
    element?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input?.closest('.password-input-wrapper')?.querySelector('.toggle-password');
    const icon = button?.querySelector('i');

    if (input && icon) {
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }
}

function togglePassword(inputId) {
    togglePasswordVisibility(inputId);
}

function toggleFaq(btn) {
    const faqItem = btn?.closest('.faq-item');
    if (faqItem) {
        faqItem.classList.toggle('active');

        const icon = btn.querySelector('i');
        if (icon) {
            icon.style.transform = faqItem.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
            icon.style.transition = 'transform 0.3s ease';
        }

        const answer = faqItem.querySelector('.faq-answer');
        if (answer) {
            if (faqItem.classList.contains('active')) {
                answer.style.display = 'block';
                setTimeout(() => {
                    answer.style.maxHeight = answer.scrollHeight + 'px';
                    answer.style.opacity = '1';
                }, 10);
            } else {
                answer.style.maxHeight = '0px';
                answer.style.opacity = '0';
                setTimeout(() => {
                    if (!faqItem.classList.contains('active')) {
                        answer.style.display = 'none';
                    }
                }, 300);
            }
        }
    }
}

function closeModal(modalId) {
    UIService.closeModal(modalId);
}

// Register all functions globally
window.showProfileModal = showProfileModal;
window.showOrdersModal = showOrdersModal;
window.loadUserOrders = loadUserOrders;
window.showCartModal = showCartModal;
window.showWishlistModal = showWishlistModal;
window.filterByCategory = filterByCategory;
window.resetFilters = resetFilters;
window.logout = function (e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    if (window.app) {
        window.app.logout();
    } else {
        // Fallback if app not initialized
        AuthService.logout();
        window.location.href = 'index.html';
    }
};
window.scrollToTop = scrollToTop;
window.scrollToProducts = scrollToProducts;
window.togglePasswordVisibility = togglePasswordVisibility;
window.togglePassword = togglePassword;
window.toggleFaq = toggleFaq;
window.closeModal = closeModal;

/* ========== 15. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø© ========== */
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    if (!AppState.isLoading) {
        UIService.showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
    }
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    if (!AppState.isLoading) {
        UIService.showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.', 'error');
    }
});

/* ========== 16. Ø¯Ø¹Ù… Service Worker ========== */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(
            (registration) => {
                console.log('âœ… Service Worker registered');
            },
            (err) => {
                console.log('âŒ Service Worker registration failed:', err);
            }
        );
    });
}

console.log('ğŸ‰ OTRUJJAH STORE V5.1 - Fixed and Ready!');