// ===================================
// OTRUJJAH - Admin Panel Script
// ===================================

// Ø¥Ø®ÙØ§Ø¡ console ÙÙŠ Production
const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
const originalConsole = {
    log: console.log,
    warn: console.warn,
    error: console.error,
    info: console.info,
    debug: console.debug
};

if (isProduction) {
    console.log = function () { };
    console.warn = function () { };
    console.error = function () { };
    console.info = function () { };
    console.debug = function () { };
}

// ========== 1. CONFIGURATION ==========
const ADMIN_CONFIG = {
    API_URL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'http://localhost:3000/api'
        : '/api',
    SESSION_KEY: 'otrujjah_admin_session',
    TOKEN_KEY: 'otrujjah_admin_token'
};

// ========== 2. GLOBAL STATE ==========
let allProducts = [];
let allCustomers = [];
let allOrders = [];

// ========== 3. AUTH FUNCTIONS ==========
function getAuthToken() {
    return localStorage.getItem(ADMIN_CONFIG.TOKEN_KEY) || sessionStorage.getItem(ADMIN_CONFIG.TOKEN_KEY);
}

function checkAdminAuth(redirect = true) {
    const token = getAuthToken();
    const sessionData = localStorage.getItem(ADMIN_CONFIG.SESSION_KEY) || sessionStorage.getItem(ADMIN_CONFIG.SESSION_KEY);

    if (token && sessionData) {
        try {
            const adminData = JSON.parse(sessionData);
            if (adminData && adminData.role === 'admin') {
                const adminNameEl = document.getElementById('admin-name');
                if (adminNameEl) {
                    adminNameEl.textContent = adminData.username || 'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„';
                }
                return true;
            }
        } catch (e) {
            console.error('Error parsing session:', e);
        }
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø®ÙˆÙ„Ø§Ù‹ØŒ Ø£Ø¹Ø¯Ù‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (redirect) {
        window.location.href = 'login.html';
    }
    return false;
}

window.adminLogout = function (e) {
    if (e) e.preventDefault();
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        localStorage.removeItem(ADMIN_CONFIG.TOKEN_KEY);
        sessionStorage.removeItem(ADMIN_CONFIG.TOKEN_KEY);
        localStorage.removeItem(ADMIN_CONFIG.SESSION_KEY);
        sessionStorage.removeItem(ADMIN_CONFIG.SESSION_KEY);
        // Ensure redirect works
        window.location.replace('login.html');
    }
};
// Map for backward compatibility
function adminLogout() { window.adminLogout(); }

/**
 * ğŸ”’ [FIXED] 
 * Ø¯Ø§Ù„Ø© Ù…ÙØ³Ø§Ø¹ÙØ¯Ø© Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø·Ù„Ø¨Ø§Øª API Ù…Ø¹ Ø§Ù„ØªÙˆÙƒÙ†
 */
async function fetchWithAuth(url, options = {}) {
    const token = getAuthToken();

    const headers = {
        'Content-Type': 'application/json',
        ...options.headers,
    };

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ù€ Headers
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch(url, { ...options, headers });

    if (response.status === 401 || response.status === 403) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­ØŒ Ø³Ø¬Ù‘Ù„ Ø®Ø±ÙˆØ¬Ù‡
        showToast('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹', 'error');
        setTimeout(adminLogout, 2000);
    }

    return response;
}


// ========== 4. UTILITY FUNCTIONS ==========
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
    toast.style.cssText = `position: fixed; bottom: 20px; left: 20px; padding: 15px 20px; 
        background: ${type === 'success' ? '#4CAF50' : '#F44336'}; color: white; 
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function formatDate(dateString) {
    if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    return new Date(dateString).toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function setupSidebar() {
    const sidebar = document.getElementById('admin-sidebar');
    const toggle = document.getElementById('sidebar-toggle');
    const mobileToggle = document.getElementById('mobile-menu-toggle');

    if (toggle) {
        toggle.onclick = () => sidebar.classList.toggle('collapsed');
    }

    if (mobileToggle) {
        mobileToggle.onclick = (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('active');
        };
    }

    document.addEventListener('click', (e) => {
        if (sidebar && sidebar.classList.contains('active') &&
            !sidebar.contains(e.target) &&
            !mobileToggle.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    });
}

function setupSearch(inputId, tableBodyId) {
    const searchInput = document.getElementById(inputId);
    if (!searchInput) return;

    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const rows = document.querySelectorAll(`#${tableBodyId} tr`);

        rows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            if (searchTerm === '' || rowText.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
}

// ========== Export Data ==========
// ========== Export Data ==========
async function exportData(type) {
    console.log(`ğŸ“¤ Exporting ${type} to CSV...`);

    // Choose headers and data based on type
    let headers = [];
    let rows = [];
    let filename = `otrujjah_${type}_${new Date().toISOString().split('T')[0]}.csv`;

    try {
        if (type === 'products') {
            headers = ['Ø§Ù„Ø±Ù‚Ù…', 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª'];
            rows = allProducts.map(p => [
                p.id,
                `"${(p.name || '').replace(/"/g, '""')}"`,
                `"${(p.type || '').replace(/"/g, '""')}"`,
                p.price,
                `"${(p.description || '').replace(/"/g, '""').substring(0, 500)}"`,
                p.rating,
                p.reviews
            ]);
        } else if (type === 'orders') {
            headers = ['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'];
            rows = allOrders.map(o => [
                o.id,
                `"${(o.username || 'Ø¹Ù…ÙŠÙ„').replace(/"/g, '""')}"`,
                `"${(o.email || '').replace(/"/g, '""')}"`,
                `"${(o.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').replace(/"/g, '""')}"`,
                o.created_at ? new Date(o.created_at).toLocaleDateString('ar-EG') : '',
                o.total_amount,
                `"${getStatusText(o.status)}"`,
                `"${(o.payment_method || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').replace(/"/g, '""')}"`
            ]);
        } else if (type === 'customers') {
            headers = ['Ø§Ù„Ø±Ù‚Ù…', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„'];
            rows = allCustomers.map(c => [
                c.id,
                `"${(c.username || '').replace(/"/g, '""')}"`,
                `"${(c.email || '').replace(/"/g, '""')}"`,
                `"${(c.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').replace(/"/g, '""')}"`,
                c.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ø¹Ù…ÙŠÙ„',
                c.created_at ? new Date(c.created_at).toLocaleDateString('ar-EG') : ''
            ]);
        }

        if (rows.length === 0) {
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
            return;
        }

        // Build CSV content with BOM for Excel compatibility
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.join(','))
        ].join('\n');

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ (CSV)', 'success');

    } catch (error) {
        console.error('Export error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±', 'error');
    }
}
// ØªØµØ¯ÙŠØ± Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©
window.exportProducts = () => exportData('products');
window.exportOrders = () => exportData('orders');
window.exportCustomers = () => exportData('customers');

// ========== 5. DASHBOARD FUNCTIONS (index.html) ==========
async function loadDashboardStats() {
    // ... (ÙƒÙˆØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª)
    console.log("Dashboard loaded");
}
// ... (Ø¯ÙˆØ§Ù„ Ø£Ø®Ø±Ù‰ Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø«Ù„ initCharts)


// ========== 6. PRODUCTS FUNCTIONS (products.html) ==========
// ØªÙ… Ù†Ù‚Ù„ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±


// ========== 7. CUSTOMERS FUNCTIONS (customers.html) ==========
async function loadCustomers() {
    const tbody = document.getElementById('customers-table-body');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</td></tr>';

    try {
        // ğŸ”’ [FIXED] - Ø§Ø³ØªØ®Ø¯Ø§Ù… fetchWithAuth
        const response = await fetchWithAuth(`${ADMIN_CONFIG.API_URL}/users`);
        if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');

        const users = await response.json();
        allCustomers = users.filter(user => user.role === 'client');

        updateCustomersCount();
        renderCustomersTable();

    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.</td></tr>';
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 'error');
    }
}

function renderCustomersTable() {
    // ... (Ù†ÙØ³ ÙƒÙˆØ¯ renderCustomersTable)
    const tbody = document.getElementById('customers-table-body');
    if (allCustomers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡.</td></tr>';
        return;
    }
    tbody.innerHTML = allCustomers.map(customer => `
        <tr data-customer-id="${customer.id}">
            <td><strong>${customer.username || 'Ø¹Ù…ÙŠÙ„'}</strong></td>
            <td>${customer.email}</td>
            <td><span class="status-badge status-info">Ø¹Ù…ÙŠÙ„</span></td>
            <td>${formatDate(customer.created_at || customer.createdAt)}</td>
            <td>
                <button class="action-btn" onclick="viewCustomer(${customer.id})" title="Ø¹Ø±Ø¶"><i class="fas fa-eye"></i></button>
                <button class="action-btn delete" onclick="deleteCustomer(${customer.id}, '${customer.username}')" title="Ø­Ø°Ù"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `).join('');
}

function updateCustomersCount() {
    const countElement = document.getElementById('customers-count');
    if (countElement) {
        countElement.textContent = allCustomers.length;
    }
}

async function viewCustomer(customerId) {
    alert(`Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ #${customerId}`);
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© modal Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„
}

function closeCustomerModal() {
    const modal = document.getElementById('customer-details-modal');
    if (modal) {
        modal.classList.remove('active');
    }
}

async function deleteCustomer(customerId, customerName) {
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customerName}"ØŸ`)) return;

    try {
        // ğŸ”’ [FIXED] - Ø§Ø³ØªØ®Ø¯Ø§Ù… fetchWithAuth
        const response = await fetchWithAuth(`${ADMIN_CONFIG.API_URL}/users/${customerId}`, {
            method: 'DELETE'
        });

        if (!response.ok && response.status !== 204) {
            throw new Error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
        }

        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        await loadCustomers(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    } catch (error) {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
    }
}


// ========== 8. ORDERS FUNCTIONS (orders.html) ==========
async function loadOrders() {
    // ... (ÙƒÙˆØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù€ loadCustomers)
    // ğŸ”’ [FIXED] - ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… fetchWithAuth
}
// ... (Ø¨Ø§Ù‚ÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø«Ù„ viewOrder, updateOrderStatus)


// ========== 9. INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹
    if (!checkAdminAuth()) return;

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø©
    setupSidebar();

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const pageId = document.body.id;

    if (pageId === 'dashboard-page') {
        loadDashboardStats();
    }
    else if (pageId === 'products-page') {
        loadProducts();
        setupSearch('product-search', 'products-table-body');
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù€ modal
        document.getElementById('product-image-upload')?.addEventListener('change', handleImageUpload);
    }
    else if (pageId === 'customers-page') {
        loadCustomers();
        setupSearch('customer-search', 'customers-table-body');
    }
    else if (pageId === 'orders-page') {
        loadOrders();
        setupSearch('order-search', 'orders-table-body');
    }
});
// ========================================
// OTRUJJAH - Products Management Script
// ========================================

// Using ADMIN_CONFIG from above

let currentEditingProduct = null;

// ========== Utility Functions ==========
function normalizeImagePath(imagePath) {
    if (!imagePath) {
        return 'assets/images/logo.png'; // Updated placeholder path relative to admin or root
    }

    // 1. External URLs (http/https)
    if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
        return imagePath;
    }

    // 2. Data URLs (Base64)
    if (imagePath.startsWith('data:image')) {
        return imagePath;
    }

    // 3. Clean up path prefix
    // The server handles static files from 'client' folder at the root URL '/'
    let cleanPath = imagePath;

    if (cleanPath.startsWith('/')) {
        cleanPath = cleanPath.substring(1);
    }

    // Remove 'client/' prefix if present, as server maps root to client
    if (cleanPath.startsWith('client/')) {
        cleanPath = cleanPath.substring(7);
    }

    // Remove '../client/' prefix if present (legacy)
    if (cleanPath.startsWith('../client/')) {
        cleanPath = cleanPath.substring(10);
    }

    // Remove '../' prefix if present
    if (cleanPath.startsWith('../')) {
        cleanPath = cleanPath.substring(3);
    }

    // Now we should have something like 'assets/images/products/foo.jpg'
    // Since admin is at /admin/, we need to go up one level ../ to access root assets
    // OR use absolute path /assets/... since server serves them at root

    return `../${cleanPath}`;
}

// ========== Load Products ==========
async function loadProducts() {
    const tbody = document.getElementById('products-table-body');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</td></tr>';

    try {
        const response = await fetch(`${ADMIN_CONFIG.API_URL}/products`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        allProducts = Array.isArray(data) ? data : (data.data || []);

        console.log('âœ… Products loaded:', allProducts.length);
        updateProductsCount();
        renderProductsTable();

    } catch (error) {
        console.error('âŒ Error loading products:', error);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${error.message}</td></tr>`;
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 'error');
    }
}

function renderProductsTable() {
    const tbody = document.getElementById('products-table-body');

    if (allProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯" Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬.</td></tr>';
        return;
    }

    tbody.innerHTML = allProducts.map(product => {
        const name = product.name || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø³Ù…Ù‰';
        const price = parseFloat(product.price) || 0;
        const type = product.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const rating = product.rating || 0;
        const reviews = product.reviews || 0;
        const imagePath = normalizeImagePath(product.image);

        console.log('ğŸ–¼ï¸ Product image:', { id: product.id, name, originalImage: product.image, normalizedPath: imagePath });

        // ØªØ­Ø¯ÙŠØ¯ placeholder URL (Ø§Ø³ØªØ®Ø¯Ø§Ù… logo)
        const hostname = window.location.hostname;
        const isVercelAdmin = hostname.includes('otrojjah-admin') || hostname.includes('admin');
        const placeholderUrl = isVercelAdmin
            ? 'https://otrojjah.vercel.app/assets/images/logo.png'
            : '../client/assets/images/logo.png';

        return `
            <tr data-product-id="${product.id}">
                <td>
                    <img src="${imagePath}"
                         alt="${name}"
                         class="product-img-small"
                         onerror="console.error('âŒ Image failed to load:', this.src); if(this.src !== '${placeholderUrl}') { this.src='${placeholderUrl}'; this.style.objectFit='contain'; this.style.backgroundColor='#f8f9fa'; }"
                         onload="console.log('âœ… Image loaded:', this.src);">
                </td>
                <td><strong>${name}</strong></td>
                <td>${type}</td>
                <td><strong>${price.toFixed(2)} Ø¬.Ù…</strong></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="color: var(--gold);">â˜…</span>
                        <span>${rating} (${reviews})</span>
                    </div>
                </td>
                <td>
                    <button class="action-btn" onclick="editProduct(${product.id})" title="ØªØ¹Ø¯ÙŠÙ„">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteProduct(${product.id})" title="Ø­Ø°Ù">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateProductsCount() {
    const countElement = document.getElementById('products-count');
    if (countElement) {
        countElement.textContent = allProducts.length;
    }
}

// ========== Modal Functions ==========
function openAddProductModal() {
    currentEditingProduct = null;
    document.getElementById('modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯';
    document.getElementById('product-form').reset();
    document.getElementById('product-id').value = '';
    document.getElementById('image-preview').style.display = 'none';

    document.querySelectorAll('input[name="categories"]').forEach(cb => cb.checked = false);

    document.getElementById('product-modal').classList.add('active');
}

async function editProduct(productId) {
    try {
        const product = allProducts.find(p => p.id === productId);
        if (!product) throw new Error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

        currentEditingProduct = product;

        document.getElementById('modal-title').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: ${product.name || 'Ù…Ù†ØªØ¬'}`;
        document.getElementById('product-id').value = product.id || '';
        document.getElementById('product-name').value = product.name || '';
        document.getElementById('product-price').value = product.price || '';
        document.getElementById('product-type').value = product.type || 'Ø±Ø¬Ø§Ù„ÙŠ';
        document.getElementById('product-description').value = product.description || '';
        document.getElementById('top-notes').value = product.top_notes || '';
        document.getElementById('middle-notes').value = product.middle_notes || '';
        document.getElementById('base-notes').value = product.base_notes || '';

        const imagePath = normalizeImagePath(product.image);
        document.getElementById('product-image').value = imagePath;

        const preview = document.getElementById('image-preview');
        if (imagePath && imagePath !== 'client/assets/images/placeholder.png') {
            preview.innerHTML = `<img src="${imagePath}" alt="Preview" style="max-width: 200px; max-height: 200px; object-fit: contain;">`;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }

        document.querySelectorAll('input[name="categories"]').forEach(cb => cb.checked = false);

        if (product.categories) {
            try {
                const categories = typeof product.categories === 'string'
                    ? JSON.parse(product.categories)
                    : product.categories;

                if (Array.isArray(categories)) {
                    categories.forEach(category => {
                        const checkbox = document.querySelector(`input[name="categories"][value="${category}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } catch (e) {
                console.error('Error parsing categories:', e);
            }
        }

        document.getElementById('product-modal').classList.add('active');

    } catch (error) {
        console.error('Error loading product:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬', 'error');
    }
}

function closeProductModal() {
    document.getElementById('product-modal').classList.remove('active');
    currentEditingProduct = null;
}

// ========== Image Upload ==========
async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showToast('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø¨ØµÙŠØºØ© JPG, PNG Ø£Ùˆ WEBP', 'error');
        event.target.value = '';
        return;
    }

    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
        showToast('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª', 'error');
        event.target.value = '';
        return;
    }

    const preview = document.getElementById('image-preview');
    const imageInput = document.getElementById('product-image');

    const reader = new FileReader();
    reader.onload = (e) => {
        preview.innerHTML = `
            <div style="position: relative; display: inline-block;">
                <img src="${e.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.875rem;">
                    <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...
                </div>
            </div>
        `;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    try {
        const token = getAuthToken();
        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            window.location.href = 'login.html';
            return;
        }

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ base64
        const base64Reader = new FileReader();
        base64Reader.onload = async (e) => {
            try {
                const base64Image = e.target.result; // data:image/jpeg;base64,...

                const response = await fetch(`${ADMIN_CONFIG.API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        image: base64Image,
                        fileName: file.name
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));

                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª (Vercel)
                    if (errorData.error && errorData.error.includes('File system')) {
                        showToast('âš ï¸ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ØºÙŠØ± Ù…ØªØ§Ø­ Ø¹Ù„Ù‰ Vercel. Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø®Ø§Ø±Ø¬ÙŠ (Imgur, Google Drive, Ø¥Ù„Ø®)', 'error');
                        preview.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: #FFF3CD; border-radius: 8px; color: #856404; border: 1px solid #FFE69C;">
                                <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 8px;"></i>
                                <p style="margin: 0; font-size: 0.875rem; font-weight: bold;">Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ØºÙŠØ± Ù…ØªØ§Ø­ Ø¹Ù„Ù‰ Vercel</p>
                                <p style="margin: 8px 0 0 0; font-size: 0.75rem;">Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø®Ø§Ø±Ø¬ÙŠ Ù…Ù† Imgur Ø£Ùˆ Google Drive</p>
                            </div>
                        `;
                        return;
                    }

                    throw new Error(errorData.error || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
                }

                const result = await response.json();

                if (result.success && result.imageUrl) {
                    const imageUrl = normalizeImagePath(result.imageUrl);
                    imageInput.value = imageUrl;

                    preview.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                            <img src="${imageUrl}" alt="Preview" style="max-width: 200px; max-height: 200px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="position: absolute; top: 8px; right: 8px; background: #4CAF50; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;">
                                <i class="fas fa-check"></i> ØªÙ…
                            </div>
                        </div>
                    `;
                    showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    throw new Error(result.error || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
                }

            } catch (error) {
                console.error('Upload error:', error);
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message, 'error');
                preview.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #FEE; border-radius: 8px; color: #D32F2F;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 8px;"></i>
                        <p style="margin: 0; font-size: 0.875rem;">ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</p>
                    </div>
                `;
            }
        };
        base64Reader.readAsDataURL(file);

    } catch (error) {
        console.error('Upload error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message, 'error');
        preview.innerHTML = `
            <div style="text-align: center; padding: 20px; background: #FEE; border-radius: 8px; color: #D32F2F;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 8px;"></i>
                <p style="margin: 0; font-size: 0.875rem;">ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</p>
            </div>
        `;
    }
}

// ========== Save Product ==========
async function saveProduct() {
    const productId = document.getElementById('product-id').value;
    const isEdit = productId !== '';

    const productName = document.getElementById('product-name').value.trim();
    const productPrice = document.getElementById('product-price').value.trim();

    if (!productName || !productPrice) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø±)', 'error');
        return;
    }

    const selectedCategories = [];
    document.querySelectorAll('input[name="categories"]:checked').forEach(cb => {
        selectedCategories.push(cb.value);
    });

    const productData = {
        name: productName,
        price: parseFloat(productPrice) || 0,
        type: document.getElementById('product-type').value || 'Ù…Ø­Ø§ÙŠØ¯',
        description: document.getElementById('product-description').value || '',
        top_notes: document.getElementById('top-notes').value || '',
        middle_notes: document.getElementById('middle-notes').value || '',
        base_notes: document.getElementById('base-notes').value || '',
        image: normalizeImagePath(document.getElementById('product-image').value),
        categories: JSON.stringify(selectedCategories)
    };

    const saveBtn = document.getElementById('save-product-btn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

    try {
        const token = getAuthToken();
        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            window.location.href = 'login.html';
            return;
        }

        const url = isEdit
            ? `${ADMIN_CONFIG.API_URL}/products/${productId}`
            : `${ADMIN_CONFIG.API_URL}/products`;

        const method = isEdit ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(productData)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬');
        }

        await response.json(); // Parse response

        showToast(isEdit ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        closeProductModal();
        await loadProducts();

    } catch (error) {
        console.error('Save error:', error);
        showToast(error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬', 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬';
    }
}

// ========== Delete Product ==========
async function deleteProduct(productId) {
    // [FIXED] Look up product name from local array instead of passing it in HTML
    const product = allProducts.find(p => p.id === productId);
    const productName = product ? product.name : 'Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯';

    console.log('ğŸ—‘ï¸ Delete product called:', { productId, productName });

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ "${productName}"ØŸ`)) {
        console.log('âŒ Delete cancelled by user');
        return;
    }

    try {
        const token = getAuthToken();
        console.log('ğŸ”‘ Token:', token ? 'exists' : 'missing');

        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            window.location.href = 'login.html';
            return;
        }

        const url = `${ADMIN_CONFIG.API_URL}/products/${productId}`;
        console.log('ğŸ“¡ DELETE request to:', url);

        const response = await fetch(url, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('ğŸ“¥ Response status:', response.status);

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('âŒ Delete failed:', errorData);
            throw new Error(errorData.error || errorData.message || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬');
        }

        const result = await response.json();
        console.log('âœ… Delete successful:', result);

        allProducts = allProducts.filter(p => p.id !== productId);
        updateProductsCount();
        renderProductsTable();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');

    } catch (error) {
        console.error('âŒ Delete error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: ' + error.message, 'error');
    }
}

// ========== Export Products ==========
function exportProducts() {
    if (allProducts.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
        return;
    }

    try {
        const headers = ['Ø§Ù„Ø±Ù‚Ù…', 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø§Ù„ÙˆØµÙ', 'Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª'];
        const csvContent = [
            headers.join(','),
            ...allProducts.map(product => [
                product.id || '',
                `"${(product.name || '').replace(/"/g, '""')}"`,
                `"${(product.type || '').replace(/"/g, '""')}"`,
                product.price || 0,
                `"${(product.description || '').replace(/"/g, '""').substring(0, 100)}"`,
                product.rating || 0,
                product.reviews || 0
            ].join(','))
        ].join('\n');

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `products_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (error) {
        console.error('Export error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 'error');
    }
}

// ========== Export Orders ==========
function exportOrders() {
    if (!allOrders || allOrders.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
        return;
    }

    try {
        const headers = ['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹'];
        const csvContent = [
            headers.join(','),
            ...allOrders.map(order => [
                order.id || '',
                `"${(order.username || 'Ø¹Ù…ÙŠÙ„').replace(/"/g, '""')}"`,
                `"${(order.email || '').replace(/"/g, '""')}"`,
                `"${(order.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').replace(/"/g, '""')}"`,
                order.created_at ? new Date(order.created_at).toLocaleDateString('ar-EG') : '',
                order.total_amount || 0,
                `"${getStatusText(order.status)}"`,
                `"${(order.payment_method || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').replace(/"/g, '""')}"`
            ].join(','))
        ].join('\n');

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `orders_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (error) {
        console.error('Export error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'error');
    }
}

// ========== Export Customers ==========
function exportCustomers() {
    console.log('ğŸ“¤ Exporting customers...', { count: allCustomers?.length });

    if (!allCustomers || allCustomers.length === 0) {
        showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
        return;
    }

    try {
        const headers = ['Ø§Ù„Ø±Ù‚Ù…', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„'];
        const csvContent = [
            headers.join(','),
            ...allCustomers.map(customer => [
                customer.id || '',
                `"${(customer.username || '').replace(/"/g, '""')}"`,
                `"${(customer.email || '').replace(/"/g, '""')}"`,
                `"${(customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯').replace(/"/g, '""')}"`,
                customer.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ø¹Ù…ÙŠÙ„',
                customer.created_at ? new Date(customer.created_at).toLocaleDateString('ar-EG') : ''
            ].join(','))
        ].join('\n');

        const BOM = '\uFEFF';
        const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });

        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `customers_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        console.log('âœ… Customers exported successfully');
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (error) {
        console.error('âŒ Export error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ' + error.message, 'error');
    }
}

// ========== Search ==========
function setupSearch() {
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    const productSearch = document.getElementById('product-search');
    if (productSearch) {
        productSearch.addEventListener('input', () => {
            const searchTerm = productSearch.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#products-table-body tr[data-product-id]');

            rows.forEach(row => {
                const productName = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                row.style.display = (searchTerm === '' || productName.includes(searchTerm)) ? '' : 'none';
            });
        });
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    const orderSearch = document.getElementById('order-search');
    if (orderSearch) {
        orderSearch.addEventListener('input', () => {
            const searchTerm = orderSearch.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#orders-table-body tr[data-order-id]');

            rows.forEach(row => {
                const orderId = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
                const customerName = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

                if (searchTerm === '' || orderId.includes(searchTerm) || customerName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    const customerSearch = document.getElementById('customer-search');
    if (customerSearch) {
        customerSearch.addEventListener('input', () => {
            const searchTerm = customerSearch.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#customers-table-body tr[data-customer-id]');

            rows.forEach(row => {
                const customerName = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
                const customerEmail = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';

                if (searchTerm === '' || customerName.includes(searchTerm) || customerEmail.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
}

// ========== Sidebar ==========
function setupSidebar() {
    const sidebar = document.getElementById('admin-sidebar');
    const toggle = document.getElementById('sidebar-toggle');
    const mobileToggle = document.getElementById('mobile-menu-toggle');

    if (toggle) {
        toggle.onclick = () => sidebar.classList.toggle('collapsed');
    }

    if (mobileToggle) {
        mobileToggle.onclick = (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('active');
        };
    }

    document.addEventListener('click', (e) => {
        if (sidebar.classList.contains('active') &&
            !sidebar.contains(e.target) &&
            !mobileToggle.contains(e.target)) {
            sidebar.classList.remove('active');
        }
    });
}

// ========== Initialize ==========
document.addEventListener('DOMContentLoaded', () => {
    if (!checkAdminAuth()) return;

    setupSidebar();
    setupSearch();
    loadProducts();

    // Event listener already added above, no need to add it again
});

document.addEventListener('click', (e) => {
    if (e.target.classList.contains('admin-modal')) {
        closeProductModal();
    }
});

/* ========== 6. Dashboard Statistics ========== */
async function loadStats() {
    console.log('ğŸ“Š Loading dashboard statistics...');

    try {
        const token = getAuthToken();
        if (!token) {
            console.error('âŒ No auth token found');
            return;
        }

        // Load products count
        const productsResponse = await fetch(`${ADMIN_CONFIG.API_URL}/products`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (productsResponse.ok) {
            const products = await productsResponse.json();
            const statsProductsEl = document.getElementById('stats-total-products');
            if (statsProductsEl) {
                statsProductsEl.textContent = products.length || 0;
            }
        }

        // Load customers count
        const customersResponse = await fetch(`${ADMIN_CONFIG.API_URL}/users`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (customersResponse.ok) {
            const users = await customersResponse.json();
            const clients = users.filter(u => u.role === 'client');
            const statsCustomersEl = document.getElementById('stats-total-customers');
            if (statsCustomersEl) {
                statsCustomersEl.textContent = clients.length || 0;
            }
        }

        // Load orders count and revenue
        const ordersResponse = await fetch(`${ADMIN_CONFIG.API_URL}/orders/admin/all`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (ordersResponse.ok) {
            const orders = await ordersResponse.json();
            const statsOrdersEl = document.getElementById('stats-total-orders');
            const statsSalesEl = document.getElementById('stats-total-sales');

            if (statsOrdersEl) {
                statsOrdersEl.textContent = orders.length || 0;
            }

            if (statsSalesEl) {
                const totalRevenue = orders.reduce((sum, order) => {
                    return sum + (parseFloat(order.total_amount) || 0);
                }, 0);
                statsSalesEl.textContent = totalRevenue.toFixed(2) + ' Ø¬.Ù…';
            }

            // Render recent orders
            renderRecentOrders(orders.slice(0, 5));
        }

        console.log('âœ… Dashboard statistics loaded');
    } catch (error) {
        console.error('âŒ Error loading dashboard statistics:', error);
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
    }
}

function renderRecentOrders(orders) {
    const tbody = document.getElementById('recent-orders-body');
    if (!tbody) return;

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø¯ÙŠØ«Ø©.</td></tr>';
        return;
    }

    tbody.innerHTML = orders.map(order => `
        <tr>
            <td><strong>#${order.id}</strong></td>
            <td>${order.username || 'Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</td>
            <td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td>
            <td><strong>${(parseFloat(order.total_amount) || 0).toFixed(2)} Ø¬.Ù…</strong></td>
            <td>${formatDate(order.created_at)}</td>
        </tr>
    `).join('');
}

function formatCurrency(amount) {
    return (parseFloat(amount) || 0).toFixed(2) + ' Ø¬.Ù…';
}

function getStatusClass(status) {
    const statusMap = {
        'pending': 'status-pending',
        'processing': 'status-processing',
        'shipped': 'status-shipped',
        'delivered': 'status-delivered',
        'cancelled': 'status-cancelled'
    };
    return statusMap[status] || 'status-pending';
}

/* ========== 7. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ========== */
async function initOrders() {
    console.log('ğŸ“‹ Loading Orders...');
    await loadOrders();
}

async function loadOrders() {
    const tbody = document.getElementById('orders-table-body');
    if (!tbody) return;
    tbody.innerHTML = `<tr><td colspan="7" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>`;

    try {
        const token = getAuthToken();
        if (!token) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</td></tr>`;
            return;
        }

        console.log('ğŸ“¡ Fetching orders from:', `${ADMIN_CONFIG.API_URL}/orders/admin/all`);

        const response = await fetch(`${ADMIN_CONFIG.API_URL}/orders/admin/all`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('ğŸ“¥ Response status:', response.status);

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('âŒ Error response:', errorData);
            throw new Error(errorData.error || errorData.message || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        allOrders = Array.isArray(data) ? data : (data.data || []);

        console.log('âœ… Orders loaded:', allOrders.length);
        updateOrdersCount();
        renderOrdersTable();

    } catch (error) {
        console.error('âŒ Error loading orders:', error);
        tbody.innerHTML = `<tr><td colspan="7" class="text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${error.message}</td></tr>`;
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'error');
    }
}

function updateOrdersCount() {
    const countElement = document.getElementById('orders-count');
    if (countElement) {
        countElement.textContent = allOrders.length;
    }
}

function renderOrdersTable() {
    const tbody = document.getElementById('orders-table-body');
    if (!tbody) return;

    if (allOrders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`;
        return;
    }

    tbody.innerHTML = allOrders.map(order => {
        const orderId = order.id || 0;
        const username = order.username || order.customer_name || 'Ø¹Ù…ÙŠÙ„';

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† shipping_address Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ø¨Ø§Ø´Ø±Ø©
        let phone = order.phone || order.customer_phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if (phone === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' && order.shipping_address) {
            try {
                const shippingAddr = typeof order.shipping_address === 'string'
                    ? JSON.parse(order.shipping_address)
                    : order.shipping_address;
                phone = shippingAddr.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            } catch (e) {
                console.error('Error parsing shipping_address for phone:', e);
            }
        }

        const totalAmount = (parseFloat(order.total_amount) || 0).toFixed(2);
        const status = order.status || 'pending';
        const createdAt = formatDate(order.created_at);

        return `
            <tr data-order-id="${orderId}">
                <td><strong>#${orderId}</strong></td>
                <td>${username}</td>
                <td><a href="tel:${phone}" style="color: var(--primary); text-decoration: none;">${phone}</a></td>
                <td>${createdAt}</td>
                <td><strong>${totalAmount} Ø¬.Ù…</strong></td>
                <td>
                    <select class="status-select status-${status}" onchange="updateOrderStatus(${orderId}, this.value)">
                        <option value="pending" ${status === 'pending' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                        <option value="processing" ${status === 'processing' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                        <option value="shipped" ${status === 'shipped' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
                        <option value="delivered" ${status === 'delivered' ? 'selected' : ''}>ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                        <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                    </select>
                </td>
                <td>
                    <button class="action-btn" onclick="viewOrderDetails(${orderId})" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteOrder(${orderId}, ${orderId})" title="Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
        'processing': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©',
        'shipped': 'ØªÙ… Ø§Ù„Ø´Ø­Ù†',
        'delivered': 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„',
        'cancelled': 'Ù…Ù„ØºÙŠ'
    };
    return statusMap[status] || status;
}

/* ========== 8. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ========== */
async function initCustomers() {
    console.log('ğŸ‘¥ Loading Customers...');
    await loadCustomers();
}

async function loadCustomers() {
    const tbody = document.getElementById('customers-table-body');
    if (!tbody) return;
    tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</td></tr>`;

    try {
        const token = getAuthToken();
        if (!token) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹</td></tr>`;
            return;
        }

        console.log('ğŸ“¡ Fetching customers from:', `${ADMIN_CONFIG.API_URL}/users`);

        const response = await fetch(`${ADMIN_CONFIG.API_URL}/users`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || errorData.message || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const users = Array.isArray(data) ? data : (data.data || []);

        console.log('âœ… Users loaded:', users.length);

        // Filter only clients, not admins - Ø­ÙØ¸ ÙÙŠ allCustomers
        allCustomers = users.filter(user => user.role === 'client');

        console.log('âœ… Customers filtered:', allCustomers.length);
        updateCustomersCount();
        renderCustomersTable();

    } catch (error) {
        console.error('âŒ Error loading customers:', error);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${error.message}</td></tr>`;
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', 'error');
    }
}

function updateCustomersCount() {
    const countElement = document.getElementById('customers-count');
    if (countElement) {
        countElement.textContent = allCustomers.length;
    }
}

function renderCustomersTable() {
    const tbody = document.getElementById('customers-table-body');
    if (!tbody) return;

    if (allCustomers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>`;
        return;
    }

    tbody.innerHTML = allCustomers.map(customer => {
        const customerId = customer.id || 0;
        const username = customer.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const email = customer.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const phone = customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const createdAt = formatDate(customer.created_at);

        return `
            <tr data-customer-id="${customerId}">
                <td><strong>#${customerId}</strong></td>
                <td>${username}</td>
                <td><a href="mailto:${email}" style="color: var(--primary); text-decoration: none;">${email}</a></td>
                <td><a href="tel:${phone}" style="color: var(--primary); text-decoration: none;">${phone}</a></td>
                <td>${createdAt}</td>
                <td>
                    <button class="action-btn" onclick="viewCustomerDetails(${customerId})" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteCustomer(${customerId}, '${username.replace(/'/g, "\\'")}')" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

async function deleteCustomer(customerId, customerName) {
    console.log('ğŸ—‘ï¸ Delete customer called:', { customerId, customerName });

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customerName}"ØŸ\n\nØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙŠØ¶Ø§Ù‹!\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`)) {
        console.log('âŒ Delete cancelled by user');
        return;
    }

    try {
        const token = getAuthToken();
        console.log('ğŸ”‘ Token:', token ? 'exists' : 'missing');

        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            window.location.href = 'login.html';
            return;
        }

        const url = `${ADMIN_CONFIG.API_URL}/users/${customerId}`;
        console.log('ğŸ“¡ DELETE request to:', url);

        const response = await fetch(url, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('ğŸ“¥ Response status:', response.status);

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('âŒ Delete failed:', errorData);
            throw new Error(errorData.error || errorData.message || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
        }

        const result = await response.json();
        console.log('âœ… Delete successful:', result);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        allCustomers = allCustomers.filter(c => c.id !== customerId);
        updateCustomersCount();
        renderCustomersTable();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');

    } catch (error) {
        console.error('âŒ Delete error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + error.message, 'error');
    }
}

async function viewCustomerDetails(customerId) {
    console.log('ğŸ‘ï¸ Viewing customer details:', customerId);

    try {
        const token = getAuthToken();
        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            return;
        }

        const response = await fetch(`${ADMIN_CONFIG.API_URL}/users/${customerId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„');
        }

        const customer = await response.json();
        console.log('âœ… Customer details loaded:', customer);

        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Modal
        const detailsContent = document.getElementById('customer-details-content');
        if (!detailsContent) {
            console.error('âŒ customer-details-content element not found');
            return;
        }

        detailsContent.innerHTML = `
            <div style="padding: 20px;">
                <h4 style="margin: 0 0 15px 0; border-bottom: 2px solid #FF6B35; padding-bottom: 10px;">
                    <i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div>
                        <strong style="color: #666;">Ø§Ù„Ø±Ù‚Ù…:</strong><br>
                        <span style="font-size: 1.1em; color: #FF6B35;">#${customer.id}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong><br>
                        <span>${customer.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong><br>
                        <span><a href="mailto:${customer.email}" style="color: var(--primary); text-decoration: none;">${customer.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</a></span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong><br>
                        <span><a href="tel:${customer.phone}" style="color: var(--primary); text-decoration: none; font-weight: bold;">ğŸ“ ${customer.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</a></span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨:</strong><br>
                        <span class="status-badge status-${customer.role === 'admin' ? 'delivered' : 'pending'}">${customer.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ø¹Ù…ÙŠÙ„'}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong><br>
                        <span>${formatDate(customer.created_at)}</span>
                    </div>
                </div>
            </div>
        `;

        const modal = document.getElementById('customer-details-modal');
        if (modal) {
            modal.classList.add('active');
        }

    } catch (error) {
        console.error('âŒ Error loading customer details:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
    }
}

function closeCustomerModal() {
    const modal = document.getElementById('customer-details-modal');
    if (modal) {
        modal.classList.remove('active');
    }
}

/* ========== 9. Utility Functions ========== */
function formatDate(dateString) {
    if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

async function updateOrderStatus(orderId, newStatus) {
    console.log('ğŸ”„ Updating order status:', { orderId, newStatus });

    try {
        const token = getAuthToken();
        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            window.location.href = 'login.html';
            return;
        }

        const response = await fetch(`${ADMIN_CONFIG.API_URL}/orders/admin/${orderId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || errorData.message || 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨');
        }

        const result = await response.json();
        console.log('âœ… Order status updated:', result);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const order = allOrders.find(o => o.id === orderId);
        if (order) {
            order.status = newStatus;
        }

        showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');

    } catch (error) {
        console.error('âŒ Error updating order status:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: ' + error.message, 'error');
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        await loadOrders();
    }
}

async function viewOrderDetails(orderId) {
    console.log('ğŸ‘ï¸ Viewing order details:', orderId);

    try {
        const token = getAuthToken();
        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            return;
        }

        const response = await fetch(`${ADMIN_CONFIG.API_URL}/orders/admin/${orderId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
            throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
        }

        const order = await response.json();
        console.log('âœ… Order details loaded:', order);

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù† shipping_address JSON
        let shippingAddress = {};
        try {
            if (typeof order.shipping_address === 'string') {
                shippingAddress = JSON.parse(order.shipping_address);
            } else if (typeof order.shipping_address === 'object' && order.shipping_address !== null) {
                shippingAddress = order.shipping_address;
            }
            console.log('ğŸ“ Shipping Address:', shippingAddress);
        } catch (e) {
            console.error('âŒ Error parsing shipping_address:', e);
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† products JSON
        let products = [];
        try {
            if (typeof order.products === 'string') {
                products = JSON.parse(order.products);
            } else if (Array.isArray(order.products)) {
                products = order.products;
            }
            console.log('ğŸ›ï¸ Products:', products);
        } catch (e) {
            console.error('âŒ Error parsing products:', e);
        }

        // Ø¨Ù†Ø§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† shipping_address
        const firstName = shippingAddress.first_name || shippingAddress.firstName || '';
        const lastName = shippingAddress.last_name || shippingAddress.lastName || '';
        const customerPhone = shippingAddress.phone || order.phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const customerName = order.username || `${firstName} ${lastName}`.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„
        const addressParts = [];
        if (shippingAddress.address) addressParts.push(shippingAddress.address);
        if (shippingAddress.city) addressParts.push(shippingAddress.city);
        if (shippingAddress.governorate) addressParts.push(shippingAddress.governorate);
        const fullAddress = addressParts.length > 0 ? addressParts.join(', ') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Modal
        document.getElementById('modal-order-id').textContent = `#${order.id}`;

        const detailsContent = document.getElementById('order-details-content');
        detailsContent.innerHTML = `
            <div style="padding: 20px;">
                <h4 style="margin: 0 0 15px 0; border-bottom: 2px solid #FF6B35; padding-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div>
                        <strong style="color: #666;">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong><br>
                        <span style="font-size: 1.1em; color: #FF6B35;">#${order.id}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong><br>
                        <span>${formatDate(order.created_at)}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø§Ù„Ø­Ø§Ù„Ø©:</strong><br>
                        <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong><br>
                        <span>${order.payment_method === 'cod' ? 'ğŸ’µ Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…' : order.payment_method === 'vodafone' ? 'ğŸ“± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´' : order.payment_method === 'instapay' ? 'ğŸ’³ Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠ' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                </div>

                <h4 style="margin: 20px 0 15px 0; border-bottom: 2px solid #FF6B35; padding-bottom: 10px;">
                    <i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div>
                        <strong style="color: #666;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</strong><br>
                        <span>${firstName} ${lastName}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong><br>
                        <span>${order.username || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong><br>
                        <span><a href="mailto:${order.email}" style="color: var(--primary); text-decoration: none;">${order.email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</a></span>
                    </div>
                    <div>
                        <strong style="color: #666;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong><br>
                        <span><a href="tel:${customerPhone}" style="color: var(--primary); text-decoration: none; font-weight: bold;">ğŸ“ ${customerPhone}</a></span>
                    </div>
                </div>

                <h4 style="margin: 20px 0 15px 0; border-bottom: 2px solid #FF6B35; padding-bottom: 10px;">
                    <i class="fas fa-map-marker-alt"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù†
                </h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #666;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong><br>
                        <span style="font-size: 1.05em;">${shippingAddress.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div>
                            <strong style="color: #666;">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</strong> ${shippingAddress.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </div>
                        <div>
                            <strong style="color: #666;">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</strong> ${shippingAddress.governorate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                        </div>
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0; border-bottom: 2px solid #FF6B35; padding-bottom: 10px;">
                    <i class="fas fa-shopping-bag"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                </h4>

                <div style="margin-bottom: 20px;">
                    ${products.length > 0 ? products.map(item => `
                        <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${item.name}</strong>
                                <br>
                                <small>Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity} Ã— ${item.price} Ø¬.Ù…</small>
                            </div>
                            <div style="font-weight: bold;">
                                ${(item.quantity * item.price).toFixed(2)} Ø¬.Ù…
                            </div>
                        </div>
                    `).join('') : '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>'}
                </div>

                <div style="text-align: left; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</strong>
                        <span>${((parseFloat(order.total_amount) || 0) - 50).toFixed(2)} Ø¬.Ù…</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong>Ø§Ù„Ø´Ø­Ù†:</strong>
                        <span>50.00 Ø¬.Ù…</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.2em; color: #FF6B35; border-top: 2px solid #FF6B35; padding-top: 10px; margin-top: 10px;">
                        <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong>
                        <strong>${(parseFloat(order.total_amount) || 0).toFixed(2)} Ø¬.Ù…</strong>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('order-details-modal').classList.add('active');

    } catch (error) {
        console.error('âŒ Error loading order details:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨', 'error');
    }
}

function closeOrderModal() {
    document.getElementById('order-details-modal').classList.remove('active');
}

async function deleteOrder(orderId, orderNumber) {
    console.log('ğŸ—‘ï¸ Delete order called:', { orderId, orderNumber });

    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ #${orderNumber}ØŸ\n\nØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`)) {
        console.log('âŒ Delete cancelled by user');
        return;
    }

    try {
        const token = getAuthToken();
        console.log('ğŸ”‘ Token:', token ? 'exists' : 'missing');

        if (!token) {
            showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
            window.location.href = 'login.html';
            return;
        }

        const url = `${ADMIN_CONFIG.API_URL}/orders/admin/${orderId}`;
        console.log('ğŸ“¡ DELETE request to:', url);

        const response = await fetch(url, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('ğŸ“¥ Response status:', response.status);

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('âŒ Delete failed:', errorData);
            throw new Error(errorData.error || errorData.message || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨');
        }

        const result = await response.json();
        console.log('âœ… Delete successful:', result);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        allOrders = allOrders.filter(o => o.id !== orderId);
        updateOrdersCount();
        renderOrdersTable();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');

    } catch (error) {
        console.error('âŒ Delete error:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨: ' + error.message, 'error');
    }
}

/* ========== 10. Page Initialization ========== */
// ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function () {
    console.log('ğŸš€ Admin Panel Loading...');

    const currentPage = window.location.pathname;
    console.log('ğŸ“„ Current page:', currentPage);

    // ØªØ®Ø·ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·
    if (currentPage.includes('login.html')) {
        console.log('ğŸ“ Login page - skipping auth check');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Admin
    console.log('ğŸ”’ Checking admin authentication...');
    if (!checkAdminAuth()) {
        console.log('âŒ Not authenticated - redirecting to login');
        return; // checkAdminAuth will redirect to login
    }

    console.log('âœ… Admin authenticated');

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ Sidebar ÙˆØ§Ù„Ø¨Ø­Ø« Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª
    setupSidebar();
    setupSearch();

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©
    if (currentPage.includes('index.html') || currentPage.endsWith('/admin/') || currentPage.endsWith('/admin')) {
        console.log('ğŸ“Š Loading dashboard...');
        loadStats();
    } else if (currentPage.includes('products.html')) {
        console.log('ğŸ“¦ Loading products...');
        loadProducts();
    } else if (currentPage.includes('customers.html')) {
        console.log('ğŸ‘¥ Loading customers...');
        initCustomers();
    } else if (currentPage.includes('orders.html')) {
        console.log('ğŸ“‹ Loading orders...');
        initOrders();
    }

    console.log('âœ… Admin Panel Loaded');
});
